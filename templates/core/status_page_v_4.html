<!-- templates/core/status_page.html -->

{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" aria-label="MietSystem Dashboard">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "MietSystem ‚Äî Dashboard" %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    {% if not request.user.is_authenticated %}
        <div class="container mx-auto p-4" role="alert">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h1 class="text-2xl font-bold text-red-600">{% trans "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω" %}</h1>
                <p>{% trans "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞" %} <a href="{% url 'admin:login' %}?next={{ request.path|urlencode }}" class="text-blue-500 hover:underline">{% trans "–≤–æ–π–¥–∏—Ç–µ" %}</a> {% trans "–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã." %}</p>
            </div>
        </div>
    {% else %}
    <div class="container mx-auto p-4 max-w-5xl">
        <h1 class="text-2xl font-bold mb-4 text-center" role="heading">{% trans "MietSystem ‚Äî Dashboard" %}</h1>
        <p class="text-right mb-4" role="status">
            {% if user_email %}
                <span class="text-gray-700">
                    {% trans "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å" %},
                    {% if user_first_name or user_last_name %}
                        {{ user_first_name }} {{ user_last_name }} ({{ user_role_display }})
                    {% else %}
                        {{ user_email }} ({{ user_role_display }})
                    {% endif %}
                </span>
                <span class="mx-2">|</span>
            {% endif %}
            <a href="{% url 'logout' %}" class="text-blue-500 hover:underline">{% trans "–í—ã–π—Ç–∏" %}</a>
        </p>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" aria-live="polite" role="region" aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
            <h2 class="text-xl font-semibold mb-2">üîî {% trans "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" %}</h2>
            <div class="space-y-2">
                {% if data.database.status == 'online' and data.redis.status == 'online' and data.celery.status == 'online' and data.s3.status == 'online' %}
                    <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ." %}</p>
                {% else %}
                    {% if data.database.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ñ—Ñ–ª–∞–π–Ω!" %}</p>
                    {% elif data.database.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –û–Ω–ª–∞–π–Ω" %}</p>
                    {% endif %}
                    {% if data.redis.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "Redis –æ—Ñ—Ñ–ª–∞–π–Ω!" %}</p>
                    {% elif data.redis.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "Redis: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "Redis: –û–Ω–ª–∞–π–Ω" %}</p>
                    {% endif %}
                    {% if data.celery.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "Celery –æ—Ñ—Ñ–ª–∞–π–Ω! –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è." %}</p>
                    {% elif data.celery.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "Celery: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "Celery: –û–Ω–ª–∞–π–Ω" %}</p>
                    {% endif %}
                    {% if data.s3.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "S3 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞." %}</p>
                    {% elif data.s3.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "S3: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "S3: –û–Ω–ª–∞–π–Ω" %}</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <script>
            setInterval(() => fetch('/api/status/refresh/').then(res => res.json()).then(data => {
                if (data.celery.status === 'offline') Toastify({ text: "{% trans 'Celery –æ—Ñ—Ñ–ª–∞–π–Ω! –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è.' %}", backgroundColor: "#dc2626" }).showToast();
                if (data.s3.status === 'offline') Toastify({ text: "{% trans 'S3 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.' %}", onClick: () => window.location.href = "{% url 'configure_s3' %}", backgroundColor: "#dc2626" }).showToast();
            }), 300000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        </script>

        {% if request.user.role == 'ADMIN' %}
        <!-- –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
            <h2 class="text-xl font-semibold mb-2">üìä {% trans "–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" %}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <i class="fas fa-clock text-green-500 mr-2"></i>
                    <span>{% trans "–í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞" %}: <strong>{{ time_now|date:"j F Y H:i:s" }}</strong> (22:27 CEST)</span>
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <i class="fas {{ data.database.status|yesno:'fa-check-circle text-green-500,fa-times-circle text-red-500' }} mr-2"></i>
                    <span>{% trans "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö" %}: <strong>{{ data.database.status|capfirst }}</strong> {% if data.database.error %}({{ data.database.error }}){% endif %}</span>
                    {% url 'view_logs' 'database' as log_url %}
                    {% if log_url %}<a href="{{ log_url }}" class="ml-2 text-blue-500 hover:underline">{% trans "–õ–æ–≥–∏" %}</a>{% endif %}
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <i class="fas {{ data.redis.status|yesno:'fa-check-circle text-green-500,fa-exclamation-triangle text-yellow-500,fa-times-circle text-red-500' }} mr-2"></i>
                    <span>{% trans "Redis" %}: <strong>{{ data.redis.status|capfirst }}</strong> {% if data.redis.latency_ms %}({{ data.redis.latency_ms }} ms){% endif %} {% if data.redis.error %}({{ data.redis.error }}){% endif %}</span>
                    {% url 'view_logs' 'redis' as log_url %}
                    {% if log_url %}<a href="{{ log_url }}" class="ml-2 text-blue-500 hover:underline">{% trans "–õ–æ–≥–∏" %}</a>{% endif %}
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <i class="fas {{ data.celery.status|yesno:'fa-check-circle text-green-500,fa-times-circle text-red-500' }} mr-2"></i>
                    <span>{% trans "Celery" %}: <strong>{{ data.celery.status|capfirst }}</strong> {% if data.celery.error %}({{ data.celery.error }}){% endif %}</span>
                    {% if data.celery.status == 'offline' %}
                    <a href="{% url 'restart_celery' %}" class="ml-2 bg-blue-500 text-white p-1 px-2 rounded hover:bg-blue-600 text-sm">{% trans "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" %}</a>
                    {% endif %}
                    {% url 'view_logs' 'celery' as log_url %}
                    {% if log_url %}<a href="{{ log_url }}" class="ml-2 text-blue-500 hover:underline">{% trans "–õ–æ–≥–∏" %}</a>{% endif %}
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <i class="fas {{ data.s3.status|yesno:'fa-check-circle text-green-500,fa-times-circle text-red-500' }} mr-2"></i>
                    <span class="{% if data.s3.status == 'offline' %}text-red-600{% endif %}">{% trans "S3" %}: <strong>{{ data.s3.status|capfirst }}</strong> {% if data.s3.error %}({{ data.s3.error }}){% endif %}</span>
                    {% if data.s3.status == 'offline' %}
                    <a href="{% url 'configure_s3' %}" class="ml-2 bg-blue-500 text-white p-1 px-2 rounded hover:bg-blue-600 text-sm">{% trans "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å" %}</a>
                    {% endif %}
                    {% url 'view_logs' 's3' as log_url %}
                    {% if log_url %}<a href="{{ log_url }}" class="ml-2 text-blue-500 hover:underline">{% trans "–õ–æ–≥–∏" %}</a>{% endif %}
                </div>
            </div>
        </div>

        <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏">
            <h2 class="text-xl font-semibold mb-2">üìà {% trans "–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏" %} (–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ data.last_updated|date:"j F Y H:i" }} CEST)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-2 border rounded shadow-sm bg-gray-50" aria-label="–ú–µ—Ç—Ä–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU">
                    <canvas id="cpuChart" class="mx-auto" style="max-height: 150px;"></canvas>
                    <p class="font-semibold text-lg mt-2">{% trans "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU" %}</p>
                    <p>{{ data.system_metrics.cpu_percent }}% / {% trans "–ú–∞–∫—Å" %}: {{ data.system_metrics.cpu_max_threshold|default:80 }}%</p>
                </div>
                <div class="text-center p-2 border rounded shadow-sm bg-gray-50" aria-label="–ú–µ—Ç—Ä–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏">
                    <canvas id="memoryChart" class="mx-auto" style="max-height: 150px;"></canvas>
                    <p class="font-semibold text-lg mt-2">{% trans "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏" %}</p>
                    <p>{{ data.system_metrics.memory_percent }}% / {% trans "–ú–∞–∫—Å" %}: {{ data.system_metrics.memory_max_threshold|default:90 }}%</p>
                </div>
                <div class="text-center p-2 border rounded shadow-sm bg-gray-50" aria-label="–ú–µ—Ç—Ä–∏–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ">
                    <canvas id="diskChart" class="mx-auto" style="max-height: 150px;"></canvas>
                    <p class="font-semibold text-lg mt-2">{% trans "–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ" %}</p>
                    <p>{{ data.system_metrics.disk_free_gb }} GB / {% trans "–ú–∏–Ω" %}: {{ data.system_metrics.disk_min_threshold|default:10 }} GB</p>
                </div>
            </div>
        </div>
        <script>
            const cpuColor = {{ data.system_metrics.cpu_percent|default:0 }} > {{ data.system_metrics.cpu_max_threshold|default:80 }} ? '#dc2626' : {{ data.system_metrics.cpu_percent|default:0 }} > {{ data.system_metrics.cpu_max_threshold|default:80 }} * 0.8 ? '#f59e0b' : '#22c55e';
            const memoryColor = {{ data.system_metrics.memory_percent|default:0 }} > {{ data.system_metrics.memory_max_threshold|default:90 }} ? '#dc2626' : {{ data.system_metrics.memory_percent|default:0 }} > {{ data.system_metrics.memory_max_threshold|default:90 }} * 0.8 ? '#f59e0b' : '#22c55e';
            const diskColor = {{ data.system_metrics.disk_free_gb|default:0 }} < {{ data.system_metrics.disk_min_threshold|default:10 }} ? '#dc2626' : {{ data.system_metrics.disk_free_gb|default:0 }} < {{ data.system_metrics.disk_min_threshold|default:10 }} * 2 ? '#f59e0b' : '#22c55e';

            new Chart(document.getElementById('cpuChart'), { type: 'doughnut', data: { datasets: [{ data: [{{ data.system_metrics.cpu_percent|default:0 }}, 100 - {{ data.system_metrics.cpu_percent|default:0 }}], backgroundColor: [cpuColor, '#e5e7eb'] }] }, options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } } });
            new Chart(document.getElementById('memoryChart'), { type: 'doughnut', data: { datasets: [{ data: [{{ data.system_metrics.memory_percent|default:0 }}, 100 - {{ data.system_metrics.memory_percent|default:0 }}], backgroundColor: [memoryColor, '#e5e7eb'] }] }, options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } } });
            new Chart(document.getElementById('diskChart'), { type: 'doughnut', data: { datasets: [{ data: [{{ data.system_metrics.disk_free_gb|default:0 }}, 100 - {{ data.system_metrics.disk_free_gb|default:0 }}], backgroundColor: [diskColor, '#e5e7eb'] }] }, options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } } });
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <!-- Redis Statistics -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis">
            <h2 class="text-xl font-semibold mb-2">üóÑÔ∏è {% trans "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis" %}</h2>
            <p>{% trans "–ö–ª—é—á–∏" %}: <strong>{{ data.redis.keys|default:"N/A" }}</strong></p>
            <p>{% trans "–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö" %}: <strong>{{ data.redis.used_memory_human|default:"N/A" }}</strong></p>
            <p>{% trans "–£—Ä–æ–≤–µ–Ω—å –ø–æ–ø–∞–¥–∞–Ω–∏–π" %}: <strong>{{ data.redis.hit_rate|default:"N/A" }}%</strong></p>
            <p>{% trans "–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—á–∏—Å—Ç–∫–∞" %}: <strong>{{ last_clear_time|default:"N/A" }}</strong></p>
            <button onclick="clearRedisCache()" class="mt-3 bg-red-500 text-white p-2 rounded hover:bg-red-600" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à Redis"><i class="fas fa-trash-alt mr-1"></i> {% trans "–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à" %}</button>
            <div class="mt-4">
                <select id="redisTimeFilter" class="p-2 border rounded mb-2" onchange="updateRedisChart()" aria-label="–§–∏–ª—å—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏ Redis">
                    <option value="24h">{% trans "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞" %}</option>
                    <option value="7d">{% trans "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π" %}</option>
                </select>
                <canvas id="redisHitRateChart" style="max-height: 200px;" aria-label="–ì—Ä–∞—Ñ–∏–∫ —É—Ä–æ–≤–Ω—è –ø–æ–ø–∞–¥–∞–Ω–∏–π Redis"></canvas>
            </div>
        </div>
        <script>
            let lastClearTime = '{{ last_clear_time|default:"N/A" }}';
            function clearRedisCache() {
                if (confirm('{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à Redis? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ." %}')) {
                    fetch('/api/redis/clear-cache/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' } })
                        .then(res => res.json()).then(data => {
                            if (data.status === 'success') {
                                Toastify({ text: "{% trans '–ö–µ—à Redis —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω!' %}", duration: 3000, backgroundColor: "#22c55e" }).showToast();
                                lastClearTime = new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Berlin' });
                                updateRedisChart();
                            } else Toastify({ text: "{% trans '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞: ' %}" + data.message, duration: 5000, backgroundColor: "#dc2626" }).showToast();
                        }).catch(() => Toastify({ text: "{% trans '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–µ—à–∞.' %}", duration: 5000, backgroundColor: "#dc2626" }).showToast());
                }
            }

            function updateRedisChart() {
                const timeFilter = document.getElementById('redisTimeFilter').value;
                let labels, values;
                if (timeFilter === '24h' && data.redis.hit_rate_history) {
                    labels = data.redis.hit_rate_history.map((_, i) => `${i}:00`); // –ß–∞—Å—ã –æ—Ç 0:00 –¥–æ 23:00
                    values = data.redis.hit_rate_history; // –ó–Ω–∞—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø–æ–ø–∞–¥–∞–Ω–∏–π
                } else if (timeFilter === '7d') {
                    labels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
                    values = [85, 90, 88, 92, 87, 89, 91]; // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ 7 –¥–Ω–µ–π
                } else {
                    labels = [];
                    values = [];
                }
                new Chart(document.getElementById('redisHitRateChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '{% trans "–£—Ä–æ–≤–µ–Ω—å –ø–æ–ø–∞–¥–∞–Ω–∏–π" %}',
                            data: values,
                            borderColor: '#f59e0b',
                            tension: 0.1,
                            fill: false,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: '{% trans "–£—Ä–æ–≤–µ–Ω—å –ø–æ–ø–∞–¥–∞–Ω–∏–π (%)" %}' },
                                ticks: { stepSize: 10 }
                            },
                            x: { title: { display: true, text: '{% trans "–í—Ä–µ–º—è" %}' } }
                        },
                        plugins: { legend: { display: true, position: 'top' } }
                    }
                });
            }
            updateRedisChart();
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <!-- Celery Tasks -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–ó–∞–¥–∞—á–∏ Celery">
            <h2 class="text-xl font-semibold mb-2">üìã {% trans "–ó–∞–¥–∞—á–∏ Celery" %}</h2>
            {% if data.celery.status == 'online' %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-2 border rounded shadow-sm bg-gray-50">
                    <h3 class="font-semibold">{% trans "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏" %}: {{ data.celery.active_tasks|default:0 }}</h3>
                    <ul class="list-disc pl-5 text-sm mt-2">
                        {% for task in data.celery.active_task_details %}
                            <li><strong>{{ task.name }}</strong> (ID: {{ task.id }}) - {% trans "–ù–∞—á–∞–ª–æ" %}: {{ task.start_time|date:"H:i:s" }}
                                <button onclick="showTaskDetails('{{ task.id }}', '{{ task.name }}', '{{ task.start_time|date:"j F Y H:i:s" }}', 'active', '{{ task.progress|default:0 }}')" class="ml-2 text-blue-500 hover:underline text-sm">{% trans "–î–µ—Ç–∞–ª–∏" %}</button>
                                <button onclick="restartTask('{{ task.id }}')" class="ml-2 text-green-500 hover:underline text-sm">{% trans "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å" %}</button>
                            </li>
                        {% empty %}
                            <li>{% trans "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á." %}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="p-2 border rounded shadow-sm bg-gray-50">
                    <h3 class="font-semibold">{% trans "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏" %}: {{ data.celery.queued_tasks|default:0 }}</h3>
                    <ul class="list-disc pl-5 text-sm mt-2">
                        {% for task in data.celery.queued_task_details %}
                            <li><strong>{{ task.name }}</strong> (ETA: {{ task.eta|date:"H:i:s" }})
                                <button onclick="showTaskDetails('{{ task.id }}', '{{ task.name }}', '{{ task.eta|date:"j F Y H:i:s" }}', 'queued', '0')" class="ml-2 text-blue-500 hover:underline text-sm">{% trans "–î–µ—Ç–∞–ª–∏" %}</button>
                            </li>
                        {% empty %}
                            <li>{% trans "–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á." %}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="mt-4 p-2 border rounded shadow-sm bg-gray-50">
                <p>{% trans "–£—Å–ø–µ—à–Ω—ã–µ –∑–∞–¥–∞—á–∏" %}: <strong>{{ data.celery.successful_tasks|default:0 }}</strong></p>
                <p>{% trans "–ù–µ—É—Å–ø–µ—à–Ω—ã–µ –∑–∞–¥–∞—á–∏" %}: <strong>{{ data.celery.failed_tasks|default:0 }}</strong></p>
            </div>
            {% else %}
            <p class="text-red-600">{% trans "–ó–∞–¥–∞—á–∏ Celery: –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ" %}</p>
            {% endif %}
        </div>
        <div id="taskDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-1/2" role="dialog" aria-labelledby="taskDetailsTitle">
                <h3 id="taskDetailsTitle" class="text-xl font-bold mb-4">{% trans "–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏" %}</h3>
                <p><strong>{% trans "ID –∑–∞–¥–∞—á–∏" %}:</strong> <span id="modalTaskId"></span></p>
                <p><strong>{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ" %}:</strong> <span id="modalTaskName"></span></p>
                <p><strong>{% trans "–°—Ç–∞—Ç—É—Å" %}:</strong> <span id="modalTaskStatus"></span></p>
                <p><strong>{% trans "–í—Ä–µ–º—è" %}:</strong> <span id="modalTaskTime"></span></p>
                <p><strong>{% trans "–ü—Ä–æ–≥—Ä–µ—Å—Å" %}:</strong> <span id="modalTaskProgress"></span>%</p>
                <button onclick="document.getElementById('taskDetailsModal').classList.add('hidden')" class="mt-4 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">{% trans "–ó–∞–∫—Ä—ã—Ç—å" %}</button>
            </div>
        </div>
        <script>
            function showTaskDetails(id, name, time, status, progress) {
                document.getElementById('modalTaskId').textContent = id;
                document.getElementById('modalTaskName').textContent = name;
                document.getElementById('modalTaskTime').textContent = time;
                document.getElementById('modalTaskStatus').textContent = status === 'active' ? '{% trans "–ê–∫—Ç–∏–≤–Ω–∞" %}' : '{% trans "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞" %}';
                document.getElementById('modalTaskProgress').textContent = progress;
                document.getElementById('taskDetailsModal').classList.remove('hidden');
                document.getElementById('taskDetailsModal').classList.add('flex');
            }
            function restartTask(taskId) {
                if (confirm('{% trans "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É?" %}')) {
                    fetch(`/api/celery/restart-task/${taskId}/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                        .then(res => res.json()).then(data => Toastify({ text: data.message, backgroundColor: data.status === 'success' ? '#22c55e' : '#dc2626' }).showToast());
                }
            }
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
            <h2 class="text-xl font-semibold mb-2">üë• {% trans "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" %}</h2>
            <canvas id="userChart" class="mb-4" style="max-height: 200px;" aria-label="–î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"></canvas>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('total')" aria-label="–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"><strong>{{ data.users.total|default:0 }}</strong> {% trans "–í—Å–µ–≥–æ" %}</div>
                <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('admin')" aria-label="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"><strong>{{ data.users.admins|default:0 }}</strong> {% trans "–ê–¥–º–∏–Ω—ã" %}</div>
                <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('landlord')" aria-label="–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª–∏"><strong>{{ data.users.landlords|default:0 }}</strong> {% trans "–õ–∞–Ω–¥–ª–æ—Ä–¥—ã" %}</div>
                <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('tenant')" aria-label="–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"><strong>{{ data.users.tenants|default:0 }}</strong> {% trans "–¢–µ–Ω–∞–Ω—Ç—ã" %}</div>
            </div>
            <div id="userTableContainer" class="mt-4 hidden">
                <h3 class="font-semibold mb-2">{% trans "–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" %}</h3>
                <div class="mb-2 flex justify-between">
                    <input type="text" id="userFilterInput" onkeyup="filterUserTable()" placeholder="{% trans '–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...' %}" class="p-2 border rounded w-1/2" aria-label="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º">
                    <button onclick="exportUsers()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600" aria-label="–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ CSV">{% trans "–°–∫–∞—á–∞—Ç—å CSV" %}</button>
                </div>
                <div class="overflow-auto max-h-60">
                    <table class="min-w-full bg-white border border-gray-200" aria-live="polite">
                        <thead><tr><th class="py-2 px-4 border-b">{% trans "Email" %}</th><th class="py-2 px-4 border-b">{% trans "–†–æ–ª—å" %}</th><th class="py-2 px-4 border-b">{% trans "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" %}</th><th class="py-2 px-4 border-b">{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th></tr></thead>
                        <tbody id="userTableBody">
                            {% for user in data.users.all_users|slice:":10" %}
                            <tr data-role="{{ user.role|lower }}">
                                <td class="py-2 px-4 border-b">{{ user.email }}</td>
                                <td class="py-2 px-4 border-b">{{ user.role_display|default:user.role }}</td>
                                <td class="py-2 px-4 border-b">{{ user.created_at|date:"j F Y" }}</td>
                                <td class="py-2 px-4 border-b">
                                    <button onclick="blockUser('{{ user.id }}')" class="text-red-500 hover:text-red-700 mr-2">{% trans "–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" %}</button>
                                    <button onclick="resetPassword('{{ user.id }}')" class="text-blue-500 hover:text-blue-700">{% trans "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è" %}</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="py-4 text-center">{% trans "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π." %}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if data.users.all_users|length > 10 %}
                <button onclick="loadMoreUsers()" class="mt-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">{% trans "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ" %}</button>
                {% endif %}
            </div>
        </div>
        <script>
            let userChartInstance = new Chart(document.getElementById('userChart'), { type: 'pie', data: { labels: ['{% trans "–ê–¥–º–∏–Ω—ã" %}', '{% trans "–õ–∞–Ω–¥–ª–æ—Ä–¥—ã" %}', '{% trans "–¢–µ–Ω–∞–Ω—Ç—ã" %}'], datasets: [{ data: [{{ data.users.admins|default:0 }}, {{ data.users.landlords|default:0 }}, {{ data.users.tenants|default:0 }}], backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b'] }] }, options: { responsive: true, onClick: (e, el) => { if (el.length) filterUsers(userChartData.labels[el[0].index].toLowerCase().replace(/ /g, '')); } } });
            let offset = 10;

            function filterUsers(role) {
                document.getElementById('userTableContainer').classList.remove('hidden');
                fetch(`/api/users/?role=${role}&offset=0&limit=10`).then(res => res.json()).then(data => renderUserTable(data.users));
            }

            function loadMoreUsers() {
                fetch(`/api/users/?offset=${offset}&limit=10`).then(res => res.json()).then(data => {
                    renderUserTable(data.users, true);
                    offset += 10;
                });
            }

            function renderUserTable(users, append = false) {
                const tbody = document.getElementById('userTableBody');
                if (!append) tbody.innerHTML = '';
                if (users.length) {
                    users.forEach(user => {
                        const row = tbody.insertRow();
                        row.dataset.role = user.role.toLowerCase();
                        row.insertCell().textContent = user.email;
                        row.insertCell().textContent = user.role_display || user.role;
                        row.insertCell().textContent = new Date(user.created_at).toLocaleDateString();
                        const actions = row.insertCell();
                        actions.innerHTML = `<button onclick="blockUser('${user.id}')" class="text-red-500 hover:text-red-700 mr-2">{% trans "–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" %}</button><button onclick="resetPassword('${user.id}')" class="text-blue-500 hover:text-blue-700">{% trans "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è" %}</button>`;
                    });
                } else tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center">{% trans "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π." %}</td></tr>';
            }

            function filterUserTable() {
                const input = document.getElementById('userFilterInput').value.toLowerCase();
                const rows = document.getElementById('userTableBody').rows;
                for (let i = 0; i < rows.length; i++) {
                    const email = rows[i].cells[0].textContent.toLowerCase();
                    const role = rows[i].cells[1].textContent.toLowerCase();
                    rows[i].style.display = (email.includes(input) || role.includes(input)) ? '' : 'none';
                }
            }

            function exportUsers() {
                fetch('/api/users/export/', { headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                    .then(res => res.blob()).then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'users.csv';
                        a.click();
                    });
            }

            function blockUser(userId) {
                if (confirm('{% trans "–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?" %}')) fetch(`/api/users/${userId}/block/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                    .then(res => res.json()).then(data => Toastify({ text: data.message, backgroundColor: data.status === 'success' ? '#22c55e' : '#dc2626' }).showToast());
            }

            function resetPassword(userId) {
                if (confirm('{% trans "–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å?" %}')) fetch(`/api/users/${userId}/reset-password/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                    .then(res => res.json()).then(data => Toastify({ text: data.message, backgroundColor: data.status === 'success' ? '#22c55e' : '#dc2626' }).showToast());
            }
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <!-- –ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞">
            <h2 class="text-xl font-semibold mb-2">üë§ {% trans "–ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞" %}</h2>
            <div class="mb-2 flex justify-between">
                <select id="loginAttemptFilter" class="p-2 border rounded" onchange="filterLoginAttempts()" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞">
                    <option value="all">{% trans "–í—Å–µ" %}</option>
                    <option value="success">{% trans "–£—Å–ø–µ—à–Ω–æ" %}</option>
                    <option value="failed">{% trans "–ù–µ—É—Å–ø–µ—à–Ω–æ" %}</option>
                </select>
                <input type="date" id="loginAttemptDate" class="p-2 border rounded" onchange="filterLoginAttempts()" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ">
            </div>
            <div class="overflow-auto max-h-60">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead><tr><th class="py-2 px-4 border-b">{% trans "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/Email" %}</th><th class="py-2 px-4 border-b">{% trans "IP" %}</th><th class="py-2 px-4 border-b">{% trans "–í—Ä–µ–º—è" %}</th><th class="py-2 px-4 border-b">{% trans "–†–µ–∑—É–ª—å—Ç–∞—Ç" %}</th><th class="py-2 px-4 border-b">{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th></tr></thead>
                    <tbody id="loginAttemptBody">
                        {% for attempt in data.login_attempts|slice:":10" %}
                        <tr>
                            <td class="py-2 px-4 border-b">{{ attempt.username|default:"N/A" }}</td>
                            <td class="py-2 px-4 border-b">{{ attempt.ip_address|default:"N/A" }}</td>
                            <td class="py-2 px-4 border-b">{{ attempt.attempt_time|date:"j F Y H:i" }}</td>
                            <td class="py-2 px-4 border-b"><span class="{% if attempt.success %}text-green-600{% else %}text-red-600{% endif %}">{{ attempt.success|yesno:"–£—Å–ø–µ—à–Ω–æ,–ù–µ—É—Å–ø–µ—à–Ω–æ" }} ({{ attempt.failures_since_start }} {% trans "—Ä–∞–∑" %})</span></td>
                            <td class="py-2 px-4 border-b">
                                {% if not attempt.success %}<button onclick="blockIp('{{ attempt.ip_address }}')" class="text-red-500 hover:text-red-700 mr-2">{% trans "–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP" %}</button>{% endif %}
                                <button onclick="sendNotification('{{ attempt.username|default:"" }}')" class="text-blue-500 hover:text-blue-700">{% trans "–£–≤–µ–¥–æ–º–∏—Ç—å" %}</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="py-4 text-center">{% trans "–ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞." %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if data.login_attempts|length > 10 %}
            <button onclick="loadMoreAttempts()" class="mt-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">{% trans "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ" %}</button>
            {% endif %}
        </div>
        <script>
            let attemptOffset = 10;
            function filterLoginAttempts() {
                const filter = document.getElementById('loginAttemptFilter').value;
                const date = document.getElementById('loginAttemptDate').value;
                fetch(`/api/login-attempts/?filter=${filter}&date=${date}&offset=0&limit=10`).then(res => res.json()).then(data => renderLoginAttempts(data.attempts));
            }
            function loadMoreAttempts() {
                const filter = document.getElementById('loginAttemptFilter').value;
                const date = document.getElementById('loginAttemptDate').value;
                fetch(`/api/login-attempts/?filter=${filter}&date=${date}&offset=${attemptOffset}&limit=10`).then(res => res.json()).then(data => {
                    renderLoginAttempts(data.attempts, true);
                    attemptOffset += 10;
                });
            }
            function renderLoginAttempts(attempts, append = false) {
                const tbody = document.getElementById('loginAttemptBody');
                if (!append) tbody.innerHTML = '';
                if (attempts.length) {
                    attempts.forEach(a => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = a.username || 'N/A';
                        row.insertCell().textContent = a.ip_address || 'N/A';
                        row.insertCell().textContent = new Date(a.attempt_time).toLocaleString();
                        row.insertCell().innerHTML = `<span class="${a.success ? 'text-green-600' : 'text-red-600'}">${a.success ? '–£—Å–ø–µ—à–Ω–æ' : '–ù–µ—É—Å–ø–µ—à–Ω–æ'} (${a.failures_since_start} —Ä–∞–∑)</span>`;
                        const actions = row.insertCell();
                        actions.innerHTML = `${!a.success ? `<button onclick="blockIp('${a.ip_address}')" class="text-red-500 hover:text-red-700 mr-2">–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP</button>` : ''}<button onclick="sendNotification('${a.username || ''}')" class="text-blue-500 hover:text-blue-700">–£–≤–µ–¥–æ–º–∏—Ç—å</button>`;
                    });
                } else tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center">{% trans "–ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞." %}</td></tr>';
            }
            function blockIp(ip) {
                if (confirm('{% trans "–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP?" %}')) fetch('/api/security/block-ip/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }, body: JSON.stringify({ ip }) })
                    .then(res => res.json()).then(data => Toastify({ text: data.message, backgroundColor: data.status === 'success' ? '#22c55e' : '#dc2626' }).showToast());
            }
            function sendNotification(username) {
                if (username && confirm('{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?" %}')) fetch('/api/notifications/send/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }, body: JSON.stringify({ username, message: "{% trans '–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.' %}" }) })
                    .then(res => res.json()).then(data => Toastify({ text: data.message, backgroundColor: data.status === 'success' ? '#22c55e' : '#dc2626' }).showToast());
                else if (!username) Toastify({ text: "{% trans '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' %}", backgroundColor: "#f59e0b" }).showToast();
            }
        </script>
        {% endif %}

        <!-- –ú–æ—è –ø–∞–Ω–µ–ª—å -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–ú–æ—è –ø–∞–Ω–µ–ª—å">
            <h2 class="text-xl font-semibold mb-2">{% trans "–ú–æ—è –ø–∞–Ω–µ–ª—å" %}</h2>
            {% if request.user.role == 'LANDLORD' %}
            <p>{% trans "–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" %}: <strong>{{ data.stats.listings|default:0 }}</strong> <a href="/api/listings/" class="text-blue-500 hover:underline ml-2">{% trans "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" %}</a> (<span class="{% if data.stats.listings_active < data.stats.listings %}text-yellow-600{% else %}text-green-600{% endif %}">{{ data.stats.listings_active|default:0 }} {% trans "–∞–∫—Ç–∏–≤–Ω–æ" %}</span>)</p>
            <p>{% trans "–ù–æ–≤—ã–µ –±—Ä–æ–Ω–∏" %}: <strong>{{ data.stats.bookings|default:0 }}</strong> <a href="/api/bookings/" class="text-blue-500 hover:underline ml-2">{% trans "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" %}</a></p>
            <p>{% trans "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞–º–∏" %}: <a href="/api/revenue/" class="text-blue-500 hover:underline">{% trans "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å" %}</a></p>
            {% elif request.user.role == 'TENANT' %}
            <p>{% trans "–ú–æ–∏ –±—Ä–æ–Ω–∏" %}: <strong>{{ data.stats.bookings|default:0 }}</strong> <a href="/api/bookings/" class="text-blue-500 hover:underline ml-2">{% trans "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" %}</a></p>
            <p>{% trans "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" %}: <strong>{{ data.stats.views|default:0 }}</strong> <a href="/api/listings/" class="text-blue-500 hover:underline ml-2">{% trans "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" %}</a></p>
            <p>{% trans "–ü–ª–∞—Ç–µ–∂–∏" %}: <a href="/api/payments/" class="text-blue-500 hover:underline">{% trans "–ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏" %}</a></p>
            {% elif request.user.role == 'ADMIN' %}
            <p>{% trans "–£ –≤–∞—Å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é." %}</p>
            {% endif %}
        </div>

        {% if request.user.role == 'ADMIN' %}
        <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API">
            <h2 class="text-xl font-semibold mb-2">üõ†Ô∏è {% trans "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API" %}</h2>
            <p>{% trans "–í—Å–µ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤" %}: <strong>{{ data.endpoints_total|default:0 }}</strong></p>
            <p>{% trans "GET" %}: <strong>{{ data.endpoints_get|default:0 }}</strong></p>
            <p>{% trans "POST" %}: <strong>{{ data.endpoints_post|default:0 }}</strong></p>
            <p>{% trans "PUT" %}: <strong>{{ data.endpoints_put|default:0 }}</strong></p>
            <p>{% trans "DELETE" %}: <strong>{{ data.endpoints_delete|default:0 }}</strong></p>
            <div class="flex space-x-4 mt-4">
                <a href="{% url 'swagger-ui' %}" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"><i class="fas fa-book mr-1"></i>{% trans "Swagger" %}</a>
                <a href="{% url 'redoc' %}" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"><i class="fas fa-book-open mr-1"></i>{% trans "Redoc" %}</a>
            </div>
            <div class="mt-4 p-2 border rounded shadow-sm bg-gray-50">
                <h3 class="font-semibold mb-2">{% trans "–¢–µ—Å—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞" %}</h3>
                <input list="endpoints" id="apiEndpointUrl" class="w-full p-2 border rounded mb-2" placeholder="{% trans '–í–≤–µ–¥–∏—Ç–µ URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /api/users/me/)' %}" aria-label="URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞">
                <datalist id="endpoints">
                    {% for endpoint in data.endpoints_list %}<option value="{{ endpoint }}">{{ endpoint }}</option>{% endfor %}
                </datalist>
                <select id="apiRequestMethod" class="p-2 border rounded mb-2 w-full" aria-label="–ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <textarea id="apiRequestBody" class="w-full p-2 border rounded mb-2 h-24" placeholder="{% trans '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ JSON –¥–ª—è POST/PUT (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)' %}" aria-label="–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞"></textarea>
                <button onclick="testEndpoint()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 w-full" aria-label="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç">{% trans "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å" %}</button>
                <div id="apiResponse" class="mt-4 p-2 bg-gray-100 rounded border border-gray-200 overflow-auto max-h-48 text-sm" aria-live="polite">{% trans "–û—Ç–≤–µ—Ç API –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å." %}</div>
            </div>
        </div>
        <script>
            function testEndpoint() {
                const url = document.getElementById('apiEndpointUrl').value;
                if (!/^(\/[a-zA-Z0-9-\/]+)$/.test(url)) {
                    Toastify({ text: "{% trans '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL.' %}", backgroundColor: "#f59e0b" }).showToast();
                    return;
                }
                const method = document.getElementById('apiRequestMethod').value;
                const body = document.getElementById('apiRequestBody').value;
                const responseDiv = document.getElementById('apiResponse');
                responseDiv.textContent = '{% trans "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..." %}';

                const options = { method, headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Accept': 'application/json' } };
                if (['POST', 'PUT'].includes(method)) {
                    try { options.body = JSON.stringify(JSON.parse(body)); options.headers['Content-Type'] = 'application/json'; }
                    catch (e) { Toastify({ text: "{% trans '–ù–µ–≤–µ—Ä–Ω—ã–π JSON.' %}", backgroundColor: "#dc2626" }).showToast(); return; }
                }

                fetch(url, options).then(res => res.text().then(text => ({ status: res.status, text }))).then(data => {
                    responseDiv.textContent = `–°—Ç–∞—Ç—É—Å: ${data.status}\n${data.text}`;
                    Toastify({ text: `{% trans "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º:" %} ${data.status}`, backgroundColor: data.status >= 200 && data.status < 300 ? "#22c55e" : "#dc2626" }).showToast();
                }).catch(e => { responseDiv.textContent = `{% trans "–û—à–∏–±–∫–∞:" %} ${e.message}`; Toastify({ text: "{% trans '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ API.' %}", backgroundColor: "#dc2626" }).showToast(); });
            }
        </script>
        {% endif %}

        <!-- –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-4" role="region" aria-label="–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏">
            <h2 class="text-xl font-semibold mb-2">üîó {% trans "–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏" %}</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% if request.user.role == 'ADMIN' %}
                <a href="{% url 'admin:index' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞"><i class="fas fa-user-shield mr-1"></i>{% trans "–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞" %}</a>
                <a href="{% url 'swagger-ui' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="Swagger"><i class="fas fa-book mr-1"></i>{% trans "Swagger" %}</a>
                <a href="{% url 'redoc' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="Redoc"><i class="fas fa-book-open mr-1"></i>{% trans "Redoc" %}</a>
                {% else %}
                <a href="{% url 'admin:index' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞"><i class="fas fa-user-shield mr-1"></i>{% trans "–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞" %}</a>
                {% endif %}
                <a href="/api/users/me/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–ü—Ä–æ—Ñ–∏–ª—å"><i class="fas fa-user mr-1"></i>{% trans "–ü—Ä–æ—Ñ–∏–ª—å" %}</a>
                <a href="/api/listings/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–û–±—ä—è–≤–ª–µ–Ω–∏—è"><i class="fas fa-home mr-1"></i>{% trans "–û–±—ä—è–≤–ª–µ–Ω–∏—è" %}</a>
                <a href="/api/bookings/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–ë—Ä–æ–Ω–∏"><i class="fas fa-calendar-check mr-1"></i>{% trans "–ë—Ä–æ–Ω–∏" %}</a>
                <a href="/api/reviews/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–û—Ç–∑—ã–≤—ã"><i class="fas fa-star mr-1"></i>{% trans "–û—Ç–∑—ã–≤—ã" %}</a>
                {% if request.user.role != 'TENANT' %}
                <a href="/api/analytics/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"><i class="fas fa-chart-line mr-1"></i>{% trans "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" %}</a>
                {% else %}
                <a href="/api/payments/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600" aria-label="–ü–ª–∞—Ç–µ–∂–∏"><i class="fas fa-credit-card mr-1"></i>{% trans "–ü–ª–∞—Ç–µ–∂–∏" %}</a>
                {% endif %}
            </div>
            <div class="mt-4">
                <form action="{% url 'set_language' %}" method="post" class="inline-block">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <select name="language" onchange="this.form.submit()" class="p-2 border rounded bg-gray-100" aria-label="–í—ã–±–æ—Ä —è–∑—ã–∫–∞">
                        {% get_available_languages as LANGUAGES %}
                        {% get_language_info_list for LANGUAGES as languages %}
                        {% for lang in languages %}
                        <option value="{{ lang.code }}" {% if lang.code == LANGUAGE_CODE %}selected{% endif %}>{{ lang.name_local }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        {% if settings.DEBUG and request.user.role == 'ADMIN' %}
        <div class="bg-yellow-100 p-4 rounded-lg shadow-md" role="region" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏">
            <h2 class="text-xl font-semibold mb-2">üß™ {% trans "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏" %}</h2>
            <ul class="list-disc pl-5">
                <li>tenant1 / pass123</li>
                <li>landlord1 / pass456</li>
                <li>admin / adminpass</li>
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}
</body>
</html>