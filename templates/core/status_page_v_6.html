<!-- templates/core/status_page.html -->

{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "MietSystem — Dashboard" %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    {% if not request.user.is_authenticated %}
        <div class="container mx-auto p-4">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h1 class="text-2xl font-bold text-red-600">{% trans "Access Denied" %}</h1>
                <p>{% trans "Please" %} <a href="{% url 'login' %}?next={{ request.path|urlencode }}" class="text-blue-500 hover:underline">{% trans "log in" %}</a> {% trans "to view the system status." %}</p>
            </div>
        </div>
    {% else %}
    <div class="container mx-auto p-4 max-w-5xl">
        <h1 class="text-2xl font-bold mb-4 text-center">{% trans "MietSystem — Dashboard" %}</h1>
        <p class="text-right mb-4">
            {% if user_email %}
                <span class="text-gray-700">
                    {% if user_avatar_url %} {# Предполагаем, что view передает user_avatar_url #}
                        <img src="{{ user_avatar_url }}" alt="{% trans 'User Avatar' %}" class="w-8 h-8 rounded-full mr-2 object-cover">
                    {% endif %}
                    {% trans "Welcome" %},
                    {% if user_first_name or user_last_name %}
                        {{ user_first_name }} {{ user_last_name }} ({{ user_role_display }})
                    {% else %}
                        {{ user_email }} ({{ user_role_display }})
                    {% endif %}
                </span>
                <span class="mx-2">|</span>
            {% endif %}
            <a href="{% url 'logout' %}" class="text-blue-500 hover:underline">{% trans "Log out" %}</a>
        </p>

        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">🔔 {% trans "Notifications" %}</h2>
            <div class="space-y-2">
                {% if data.database.status == 'online' and data.redis.status == 'online' and data.celery.status == 'online' and data.s3.status == 'online' %}
                    <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "All systems are operating normally." %}</p>
                {% else %}
                    {% if data.database.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "Database is offline!" %}</p>
                    {% elif data.database.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "Database: Warning!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "Database: Online" %}</p>
                    {% endif %}

                    {% if data.redis.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "Redis is offline!" %}</p>
                    {% elif data.redis.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "Redis: Warning!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "Redis: Online" %}</p>
                    {% endif %}

                    {% if data.celery.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "Celery is offline! Background tasks are not running." %}</p>
                    {% elif data.celery.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "Celery: Warning!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "Celery: Online" %}</p>
                    {% endif %}

                    {% if data.s3.status == 'offline' %}
                        <p class="text-red-600 flex items-center"><i class="fas fa-times-circle mr-2"></i> {% trans "S3 is not configured. File uploads are unavailable." %}</p>
                    {% elif data.s3.status == 'warning' %}
                        <p class="text-yellow-600 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> {% trans "S3: Warning!" %}</p>
                    {% else %}
                        <p class="text-green-600 flex items-center"><i class="fas fa-check-circle mr-2"></i> {% trans "S3: Online" %}</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <script>
            {% if data.celery.status == 'offline' %}
            Toastify({
                text: "{% trans 'Celery is offline! Background tasks are not running.' %}",
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc2626",
            }).showToast();
            {% endif %}
            {% if data.s3.status == 'offline' %}
            Toastify({
                text: "{% trans 'S3 is not configured. Click to configure.' %}",
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc2626",
                onClick: () => window.location.href = "{% url 'configure_s3' %}"
            }).showToast();
            {% endif %}
        </script>

        {% if request.user.role == 'ADMIN' %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">📊 {% trans "System Information" %}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <span class="inline-block w-4 h-4 rounded-full bg-green-500 mr-2 flex-shrink-0"></span>
                    <span>{% trans "Server Time" %}: <strong>{{ time_now|date:"j F Y H:i:s" }}</strong></span>
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <span class="inline-block w-4 h-4 rounded-full {{ data.database.status|yesno:'bg-green-500,bg-red-500' }} mr-2 flex-shrink-0"></span>
                    <span>{% trans "Database" %}: <strong>{{ data.database.status|capfirst }}</strong> {% if data.database.error %}({{ data.database.error }}){% endif %}</span>
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <span class="inline-block w-4 h-4 rounded-full {% if data.redis.status == 'online' %}bg-green-500{% elif data.redis.status == 'warning' %}bg-yellow-500{% else %}bg-red-500{% endif %} mr-2 flex-shrink-0"></span>
                    <span>{% trans "Redis" %}: <strong>{{ data.redis.status|capfirst }}</strong> {% if data.redis.latency_ms %}({{ data.redis.latency_ms }} ms){% endif %} {% if data.redis.error %}({{ data.redis.error }}){% endif %}</span>
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <span class="inline-block w-4 h-4 rounded-full {{ data.celery.status|yesno:'bg-green-500,bg-red-500' }} mr-2 flex-shrink-0"></span>
                    <span>{% trans "Celery" %}: <strong>{{ data.celery.status|capfirst }}</strong> {% if data.celery.error %}({{ data.celery.error }}){% endif %}</span>
                    {% if data.celery.status == 'offline' %}
                    <a href="{% url 'restart_celery' %}" class="ml-2 bg-blue-500 text-white p-1 px-2 rounded hover:bg-blue-600 text-sm">{% trans "Restart" %}</a>
                    {% endif %}
                </div>
                <div class="flex items-center p-2 border rounded shadow-sm bg-gray-50">
                    <span class="inline-block w-4 h-4 rounded-full {{ data.s3.status|yesno:'bg-green-500,bg-red-500' }} mr-2 flex-shrink-0"></span>
                    <span class="{% if data.s3.status == 'offline' %}text-red-600{% endif %}">{% trans "S3" %}: <strong>{{ data.s3.status|capfirst }}</strong> {% if data.s3.error %}({{ data.s3.error }}){% endif %}</span>
                    {% if data.s3.status == 'offline' %}
                    <a href="{% url 'configure_s3' %}" class="ml-2 bg-blue-500 text-white p-1 px-2 rounded hover:bg-blue-600 text-sm">{% trans "Configure" %}</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">📈 {% trans "System Metrics" %} (Обновлено: {{ data.last_updated }})</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-2 border rounded shadow-sm bg-gray-50">
                    <canvas id="cpuChart" class="mx-auto" style="max-height: 150px;"></canvas>
                    <p class="font-semibold text-lg mt-2">{% trans "CPU Usage" %}</p>
                    <p>{{ data.system_metrics.cpu_percent }}% / {% trans "Max" %}: {{ data.system_metrics.cpu_max_threshold }}%</p>
                </div>
                <div class="text-center p-2 border rounded shadow-sm bg-gray-50">
                    <canvas id="memoryChart" class="mx-auto" style="max-height: 150px;"></canvas>
                    <p class="font-semibold text-lg mt-2">{% trans "Memory Usage" %}</p>
                    <p>{{ data.system_metrics.memory_percent }}% / {% trans "Max" %}: {{ data.system_metrics.memory_max_threshold }}%</p>
                </div>
                <div class="text-center p-2 border rounded shadow-sm bg-gray-50">
                    <canvas id="diskChart" class="mx-auto" style="max-height: 150px;"></canvas>
                    <p class="font-semibold text-lg mt-2">{% trans "Free Disk Space" %}</p>
                    <p>{{ data.system_metrics.disk_free_gb }} GB / {% trans "Min" %}: {{ data.system_metrics.disk_min_threshold }} GB</p>
                </div>
            </div>
        </div>
        <script>
            // Добавим значения порогов для корректного отображения цветов
            const cpuUsage = {{ data.system_metrics.cpu_percent | default:0 }};
            const memoryUsage = {{ data.system_metrics.memory_percent | default:0 }};
            const diskFree = {{ data.system_metrics.disk_free_gb | default:0 }};

            // Заглушки для порогов, если они не приходят из контекста. В идеале их должен возвращать 'status_page_view'.
            const cpuMaxThreshold = {{ data.system_metrics.cpu_max_threshold | default:80 }}; // Например, 80%
            const memoryMaxThreshold = {{ data.system_metrics.memory_max_threshold | default:90 }}; // Например, 90%
            const diskMinThreshold = {{ data.system_metrics.disk_min_threshold | default:10 }}; // Например, 10 GB

            const cpuColor = cpuUsage > cpuMaxThreshold ? '#dc2626' : (cpuUsage > (cpuMaxThreshold * 0.8)) ? '#f59e0b' : '#22c55e';
            const memoryColor = memoryUsage > memoryMaxThreshold ? '#dc2626' : (memoryUsage > (memoryMaxThreshold * 0.8)) ? '#f59e0b' : '#22c55e';
            const diskColor = diskFree < diskMinThreshold ? '#dc2626' : (diskFree < (diskMinThreshold * 2)) ? '#f59e0b' : '#22c55e'; // Если свободно менее 20GB, предупреждение; менее 10GB, критично

            new Chart(document.getElementById('cpuChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{ data: [cpuUsage, 100 - cpuUsage], backgroundColor: [cpuColor, '#e5e7eb'] }]
                },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('memoryChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{ data: [memoryUsage, 100 - memoryUsage], backgroundColor: [memoryColor, '#e5e7eb'] }]
                },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('diskChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{ data: [diskFree, 100 - diskFree], backgroundColor: [diskColor, '#e5e7eb'] }]
                },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">🗄️ {% trans "Redis Statistics" %}</h2>
            <p>{% trans "Keys" %}: <strong>{{ data.redis.keys|default:"N/A" }}</strong></p>
            <p>{% trans "Data Size" %}: <strong>{{ data.redis.used_memory_human|default:"N/A" }}</strong></p>
            <p>{% trans "Hit Rate" %}: <strong>{{ data.redis.hit_rate|default:"N/A" }}%</strong></p>
            <button onclick="clearRedisCache()" class="mt-3 bg-red-500 text-white p-2 rounded hover:bg-red-600"><i class="fas fa-trash-alt mr-1"></i> {% trans "Clear Cache" %}</button>
            <div class="mt-4">
                <h3 class="font-semibold mb-2">{% trans "Hit Rate (Last 24 Hours)" %}</h3>
                <canvas id="redisHitRateChart" style="max-height: 200px;"></canvas>
            </div>
        </div>
        <script>
            function clearRedisCache() {
                if (confirm('{% trans "Are you sure you want to clear Redis cache? This action cannot be undone." %}')) {
                    fetch('/api/redis/clear-cache/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Toastify({
                                text: "{% trans 'Redis cache cleared successfully!' %}",
                                duration: 3000,
                                backgroundColor: "#22c55e",
                            }).showToast();
                            // Optionally refresh the page or update data
                            setTimeout(() => location.reload(), 3000);
                        } else {
                            Toastify({
                                text: "{% trans 'Failed to clear Redis cache: ' %}" + data.message,
                                duration: 5000,
                                backgroundColor: "#dc2626",
                            }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing Redis cache:', error);
                        Toastify({
                            text: "{% trans 'An error occurred while clearing Redis cache.' %}",
                            duration: 5000,
                            backgroundColor: "#dc2626",
                        }).showToast();
                    });
                }
            }

            // График Redis Hit Rate (предполагаем, что data.redis.hit_rate_history содержит метки и данные)
            // Пример данных: { labels: ["1h ago", "2h ago", ...], values: [95, 92, ...] }
            const redisHitRateData = {
                labels: Array.from({length: 24}, (_, i) => `${24 - i}h ago`).reverse(), // Пример меток
                datasets: [{
                    label: '{% trans "Hit Rate" %}',
                    data: {{ data.redis.hit_rate_history|default:"[]"|safe }}, // данные должны приходить из бэкенда
                    borderColor: '#f59e0b',
                    tension: 0.1,
                    fill: false
                }]
            };

            new Chart(document.getElementById('redisHitRateChart'), {
                type: 'line',
                data: redisHitRateData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '{% trans "Hit Rate (%)" %}'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '{% trans "Time" %}'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">📋 {% trans "Celery Tasks" %}</h2>
            {% if data.celery.status == 'online' %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-2 border rounded shadow-sm bg-gray-50">
                    <h3 class="font-semibold">{% trans "Active Tasks" %}: {{ data.celery.active_tasks|default:0 }}</h3>
                    <ul class="list-disc pl-5 text-sm mt-2">
                        {% for task in data.celery.active_task_details %}
                            <li>
                                <strong>{{ task.name }}</strong> (ID: {{ task.id }}) - {% trans "Started" %}: {{ task.start_time|date:"H:i:s" }}
                                <button onclick="showTaskDetails('{{ task.id }}', '{{ task.name }}', '{{ task.start_time|date:"j F Y H:i:s" }}', 'active')" class="ml-2 text-blue-500 hover:underline text-sm">{% trans "Details" %}</button>
                            </li>
                        {% empty %}
                            <li>{% trans "No active tasks." %}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="p-2 border rounded shadow-sm bg-gray-50">
                    <h3 class="font-semibold">{% trans "Queued Tasks" %}: {{ data.celery.queued_tasks|default:0 }}</h3>
                    <ul class="list-disc pl-5 text-sm mt-2">
                        {% for task in data.celery.queued_task_details %}
                            <li>
                                <strong>{{ task.name }}</strong> (ETA: {{ task.eta|date:"H:i:s" }})
                                <button onclick="showTaskDetails('{{ task.id }}', '{{ task.name }}', '{{ task.eta|date:"j F Y H:i:s" }}', 'queued')" class="ml-2 text-blue-500 hover:underline text-sm">{% trans "Details" %}</button>
                            </li>
                        {% empty %}
                            <li>{% trans "No queued tasks." %}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="mt-4 p-2 border rounded shadow-sm bg-gray-50">
                <p>{% trans "Successful Tasks" %}: <strong>{{ data.celery.successful_tasks|default:0 }}</strong></p>
                <p>{% trans "Failed Tasks" %}: <strong>{{ data.celery.failed_tasks|default:0 }}</strong></p>
            </div>
            {% else %}
            <p class="text-red-600">{% trans "Celery Tasks: Unavailable" %}</p>
            {% endif %}
        </div>

        <div id="taskDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-1/2">
                <h3 class="text-xl font-bold mb-4">{% trans "Task Details" %}</h3>
                <p><strong>{% trans "Task ID" %}:</strong> <span id="modalTaskId"></span></p>
                <p><strong>{% trans "Task Name" %}:</strong> <span id="modalTaskName"></span></p>
                <p><strong>{% trans "Status" %}:</strong> <span id="modalTaskStatus"></span></p>
                <p><strong>{% trans "Time" %}:</strong> <span id="modalTaskTime"></span></p>
                <button onclick="document.getElementById('taskDetailsModal').classList.add('hidden')" class="mt-4 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">{% trans "Close" %}</button>
            </div>
        </div>
        <script>
            function showTaskDetails(id, name, time, status) {
                document.getElementById('modalTaskId').textContent = id;
                document.getElementById('modalTaskName').textContent = name;
                document.getElementById('modalTaskTime').textContent = time;
                document.getElementById('modalTaskStatus').textContent = status === 'active' ? '{% trans "Active" %}' : '{% trans "Queued" %}';
                document.getElementById('taskDetailsModal').classList.remove('hidden');
                document.getElementById('taskDetailsModal').classList.add('flex'); // Показываем как flex для центрирования
            }
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-2">👥 {% trans "Users" %}</h2>
                <canvas id="userChart" class="mb-4" style="max-height: 200px;"></canvas>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('total')"><strong>{{ data.users.total|default:0 }}</strong> {% trans "Total Users" %}</div>
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('admin')"><strong>{{ data.users.admins|default:0 }}</strong> {% trans "Admins" %}</div>
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('landlord')"><strong>{{ data.users.landlords|default:0 }}</strong> {% trans "Landlords" %}</div>
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('tenant')"><strong>{{ data.users.tenants|default:0 }}</strong> {% trans "Tenants" %}</div>
                </div>

                <div id="userTableContainer" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">{% trans "User List" %}</h3>
                    <div class="mb-2">
                        <input type="text" id="userFilterInput" onkeyup="filterUserTable()" placeholder="{% trans 'Search for users...' %}" class="p-2 border rounded w-full">
                    </div>
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b">{% trans "Email" %}</th>
                                <th class="py-2 px-4 border-b">{% trans "Role" %}</th>
                                <th class="py-2 px-4 border-b">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            {# Здесь будут динамически загружаться пользователи через JavaScript/AJAX #}
                            {# Пример: #}
                            {% comment %}
                            {% for user_item in data.users.all_users %}
                            <tr data-role="{{ user_item.role|lower }}">
                                <td class="py-2 px-4 border-b">{{ user_item.email }}</td>
                                <td class="py-2 px-4 border-b">{{ user_item.role }}</td>
                                <td class="py-2 px-4 border-b">
                                    <button onclick="blockUser('{{ user_item.id }}')" class="text-red-500 hover:text-red-700 mr-2">{% trans "Block" %}</button>
                                    <button onclick="resetPassword('{{ user_item.id }}')" class="text-blue-500 hover:text-blue-700">{% trans "Reset Pass" %}</button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% endcomment %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-2">📢 {% trans "System Objects" %}</h2>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-center"><strong>{{ data.stats.listings|default:0 }}</strong> {% trans "Listings" %}</div>
                    <div class="text-center"><strong>{{ data.stats.bookings|default:0 }}</strong> {% trans "Bookings" %}</div>
                    <div class="text-center"><strong>{{ data.stats.reviews|default:0 }}</strong> {% trans "Reviews" %}</div>
                    <div class="text-center"><strong>{{ data.stats.locations|default:0 }}</strong> {% trans "Locations" %}</div>
                </div>
            </div>
        </div>
        <script>
            let userChartInstance = null;
            const userChartData = {
                labels: ['{% trans "Admins" %}', '{% trans "Landlords" %}', '{% trans "Tenants" %}'],
                datasets: [{
                    data: [{{ data.users.admins|default:0 }}, {{ data.users.landlords|default:0 }}, {{ data.users.tenants|default:0 }}],
                    backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b']
                }]
            };

            function initUserChart() {
                const ctx = document.getElementById('userChart').getContext('2d');
                userChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: userChartData,
                    options: {
                        responsive: true,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const role = userChartData.labels[index].toLowerCase();
                                filterUsers(role.replace(/ /g, '')); // Удаляем пробелы, чтобы соответствовать 'admin', 'landlord', 'tenant'
                            }
                        }
                    }
                });
            }
            initUserChart(); // Инициализация графика при загрузке страницы

            let allUsersData = []; // Для хранения всех данных о пользователях

            function fetchUsersAndRenderTable(role = 'total') {
                document.getElementById('userTableContainer').classList.remove('hidden');
                const userTableBody = document.getElementById('userTableBody');
                userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">{% trans "Loading users..." %}</td></tr>';

                fetch('/api/users/all_users_for_admin_dashboard/') // Вам нужно будет создать такой endpoint на бэкенде
                    .then(response => response.json())
                    .then(data => {
                        allUsersData = data.users || []; // Убедитесь, что ваш API возвращает {'users': [...]}
                        renderUserTable(role);
                    })
                    .catch(error => {
                        console.error('Error fetching users:', error);
                        userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-600">{% trans "Failed to load users." %}</td></tr>';
                    });
            }

            function renderUserTable(roleFilter = 'total') {
                const userTableBody = document.getElementById('userTableBody');
                userTableBody.innerHTML = '';
                const filteredUsers = allUsersData.filter(user => {
                    if (roleFilter === 'total') return true;
                    return user.role.toLowerCase() === roleFilter;
                });

                if (filteredUsers.length === 0) {
                    userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">{% trans "No users found for this filter." %}</td></tr>';
                    return;
                }

                filteredUsers.forEach(user => {
                    const row = userTableBody.insertRow();
                    row.dataset.role = user.role.toLowerCase();
                    row.insertCell().textContent = user.email;
                    row.insertCell().textContent = user.role_display || user.role; // Используем role_display если есть
                    const actionsCell = row.insertCell();
                    actionsCell.className = "py-2 px-4 border-b";
                    actionsCell.innerHTML = `
                        <button onclick="blockUser('${user.id}')" class="text-red-500 hover:text-red-700 mr-2">{% trans "Block" %}</button>
                        <button onclick="resetPassword('${user.id}')" class="text-blue-500 hover:text-blue-700">{% trans "Reset Pass" %}</button>
                    `;
                });
            }

            function filterUsers(role) {
                if (allUsersData.length === 0) {
                    fetchUsersAndRenderTable(role);
                } else {
                    renderUserTable(role);
                }
            }

            function filterUserTable() {
                const input = document.getElementById('userFilterInput');
                const filter = input.value.toLowerCase();
                const table = document.getElementById('userTableBody');
                const tr = table.getElementsByTagName('tr');

                for (let i = 0; i < tr.length; i++) {
                    const tdEmail = tr[i].getElementsByTagName('td')[0];
                    const tdRole = tr[i].getElementsByTagName('td')[1];
                    if (tdEmail || tdRole) {
                        const emailText = tdEmail ? tdEmail.textContent.toLowerCase() : '';
                        const roleText = tdRole ? tdRole.textContent.toLowerCase() : '';
                        if (emailText.indexOf(filter) > -1 || roleText.indexOf(filter) > -1) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }
                }
            }

            // Заглушки для функций действий (потребуют AJAX-запросов к бэкенду)
            function blockUser(userId) {
                if (confirm(`{% trans "Are you sure you want to block user ID:" %} ${userId}?`)) {
                    fetch(`/api/users/${userId}/block/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Toastify({ text: `{% trans "User ID:" %} ${userId} {% trans "blocked." %}`, backgroundColor: "#22c55e" }).showToast();
                        } else {
                            Toastify({ text: `{% trans "Failed to block user:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast();
                        }
                    });
                }
            }

            function resetPassword(userId) {
                if (confirm(`{% trans "Are you sure you want to reset password for user ID:" %} ${userId}?`)) {
                    fetch(`/api/users/${userId}/reset-password/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Toastify({ text: `{% trans "Password for user ID:" %} ${userId} {% trans "reset." %}`, backgroundColor: "#22c55e" }).showToast();
                        } else {
                            Toastify({ text: `{% trans "Failed to reset password:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast();
                        }
                    });
                }
            }
        </script>
        {% endif %}

        {% if request.user.role == 'ADMIN' %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">👤 {% trans "User Login Attempts" %}</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b text-left">{% trans "User/Email" %}</th>
                            <th class="py-2 px-4 border-b text-left">{% trans "IP Address" %}</th>
                            <th class="py-2 px-4 border-b text-left">{% trans "Time" %}</th>
                            <th class="py-2 px-4 border-b text-left">{% trans "Result" %}</th>
                            <th class="py-2 px-4 border-b text-left">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attempt in data.login_attempts %}
                        <tr>
                            <td class="py-2 px-4 border-b">{{ attempt.username|default:"N/A" }}</td>
                            <td class="py-2 px-4 border-b">{{ attempt.ip_address|default:"N/A" }}</td>
                            <td class="py-2 px-4 border-b">{{ attempt.attempt_time|date:"j F Y H:i:s" }}</td>
                            <td class="py-2 px-4 border-b">
                                <span class="{% if attempt.success %}text-green-600{% else %}text-red-600{% endif %}">
                                    {% if attempt.success %}{% trans "Success" %}{% else %}{% trans "Failed" %} ({{ attempt.failures_since_start }} {% trans "times" %}){% endif %}
                                </span>
                            </td>
                            <td class="py-2 px-4 border-b">
                                {% if not attempt.success %}
                                <button onclick="blockIp('{{ attempt.ip_address }}')" class="text-red-500 hover:text-red-700 text-sm mr-2">{% trans "Block IP" %}</button>
                                {% endif %}
                                <button onclick="sendNotification('{{ attempt.username|default:"" }}')" class="text-blue-500 hover:text-blue-700 text-sm">{% trans "Notify User" %}</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="py-4 text-center">{% trans "No recent login attempts." %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <script>
            // Функции для блокировки IP и отправки уведомлений
            function blockIp(ipAddress) {
                if (confirm(`{% trans "Are you sure you want to block IP address:" %} ${ipAddress}?`)) {
                    fetch(`/api/security/block-ip/`, { // Вам нужно будет создать такой endpoint
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ip: ipAddress })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Toastify({ text: `{% trans "IP Address:" %} ${ipAddress} {% trans "blocked." %}`, backgroundColor: "#22c55e" }).showToast();
                        } else {
                            Toastify({ text: `{% trans "Failed to block IP:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('Error blocking IP:', error);
                        Toastify({ text: "{% trans 'An error occurred while blocking IP.' %}", backgroundColor: "#dc2626" }).showToast();
                    });
                }
            }

            function sendNotification(username) {
                if (username && confirm(`{% trans "Send notification to user:" %} ${username}?`)) {
                    fetch(`/api/notifications/send/`, { // Вам нужно будет создать такой endpoint
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username: username, message: "{% trans 'There was a recent login attempt on your account.' %}" })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Toastify({ text: `{% trans "Notification sent to" %} ${username}.`, backgroundColor: "#22c55e" }).showToast();
                        } else {
                            Toastify({ text: `{% trans "Failed to send notification:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('Error sending notification:', error);
                        Toastify({ text: "{% trans 'An error occurred while sending notification.' %}", backgroundColor: "#dc2626" }).showToast();
                    });
                } else if (!username) {
                     Toastify({ text: "{% trans 'Cannot send notification: User email/username is missing.' %}", backgroundColor: "#f59e0b" }).showToast();
                }
            }
        </script>
        {% endif %}

        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">{% trans "My Dashboard" %}</h2>
            {% if request.user.role == 'LANDLORD' %}
            <p>{% trans "My Listings" %}: <strong>{{ data.stats.listings|default:0 }}</strong> <a href="/api/listings/" class="text-blue-500 hover:underline ml-2">{% trans "View all listings" %}</a></p>
            <p>{% trans "New Bookings" %}: <strong>{{ data.stats.bookings|default:0 }}</strong> <a href="/api/bookings/" class="text-blue-500 hover:underline ml-2">{% trans "View all bookings" %}</a></p>
            {% elif request.user.role == 'TENANT' %}
            <p>{% trans "My Bookings" %}: <strong>{{ data.stats.bookings|default:0 }}</strong> <a href="/api/bookings/" class="text-blue-500 hover:underline ml-2">{% trans "View all bookings" %}</a></p>
            <p>{% trans "Viewed Listings" %}: <strong>{{ data.stats.views|default:0 }}</strong> <a href="/api/listings/" class="text-blue-500 hover:underline ml-2">{% trans "View all listings" %}</a></p>
            {% elif request.user.role == 'ADMIN' %}
            <p>{% trans "You have full access to system monitoring and user management." %}</p>
            {% endif %}
        </div>

        {% if request.user.role == 'ADMIN' %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">🛠️ {% trans "API Testing" %}</h2>
            <p>{% trans "Total Endpoints" %}: <strong>{{ data.endpoints_total|default:0 }}</strong></p>
            <p>{% trans "GET Methods" %}: <strong>{{ data.endpoints_get|default:0 }}</strong></p>
            <p>{% trans "POST Methods" %}: <strong>{{ data.endpoints_post|default:0 }}</strong></p>
            <p>{% trans "PUT Methods" %}: <strong>{{ data.endpoints_put|default:0 }}</strong></p>
            <p>{% trans "DELETE Methods" %}: <strong>{{ data.endpoints_delete|default:0 }}</strong></p>
            <div class="flex space-x-4 mt-4">
                <a href="{% url 'swagger-ui' %}" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"><i class="fas fa-book mr-1"></i>{% trans "Test API (Swagger)" %}</a>
                <a href="{% url 'redoc' %}" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"><i class="fas fa-book-open mr-1"></i>{% trans "Redoc" %}</a>
            </div>
            <div class="mt-4 p-2 border rounded shadow-sm bg-gray-50">
                <h3 class="font-semibold mb-2">{% trans "Test Single Endpoint" %}</h3>
                <input type="text" id="apiEndpointUrl" class="w-full p-2 border rounded mb-2" placeholder="{% trans 'Enter API endpoint URL (e.g., /api/users/me/)' %}">
                <select id="apiRequestMethod" class="p-2 border rounded mb-2 w-full">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <textarea id="apiRequestBody" class="w-full p-2 border rounded mb-2 h-24" placeholder="{% trans 'Enter JSON request body for POST/PUT (optional)' %}"></textarea>
                <button onclick="testEndpoint()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600 w-full">{% trans "Test Endpoint" %}</button>
                <div id="apiResponse" class="mt-4 p-2 bg-gray-100 rounded border border-gray-200 overflow-auto max-h-48 text-sm">
                    {% trans "API Response will appear here." %}
                </div>
            </div>
        </div>
        <script>
            function testEndpoint() {
                const url = document.getElementById('apiEndpointUrl').value;
                const method = document.getElementById('apiRequestMethod').value;
                const body = document.getElementById('apiRequestBody').value;
                const responseDiv = document.getElementById('apiResponse');

                if (!url) {
                    Toastify({ text: "{% trans 'Please enter an API endpoint URL.' %}", backgroundColor: "#f59e0b" }).showToast();
                    return;
                }

                responseDiv.textContent = '{% trans "Testing..." %}';

                const options = {
                    method: method,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Accept': 'application/json'
                    }
                };

                if (method === 'POST' || method === 'PUT') {
                    try {
                        options.body = JSON.parse(body); // Ensure body is valid JSON object
                        options.headers['Content-Type'] = 'application/json';
                    } catch (e) {
                        Toastify({ text: "{% trans 'Invalid JSON body.' %}", backgroundColor: "#dc2626" }).showToast();
                        responseDiv.textContent = '{% trans "Error: Invalid JSON body." %}';
                        return;
                    }
                }

                fetch(url, options)
                    .then(response => {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            return response.json().then(json => ({ status: response.status, json: json }));
                        } else {
                            return response.text().then(text => ({ status: response.status, text: text }));
                        }
                    })
                    .then(data => {
                        if (data.json) {
                            responseDiv.textContent = `Status: ${data.status}\n${JSON.stringify(data.json, null, 2)}`;
                        } else {
                            responseDiv.textContent = `Status: ${data.status}\n${data.text}`;
                        }
                        Toastify({ text: `{% trans "Test completed with status:" %} ${data.status}`, backgroundColor: data.status >= 200 && data.status < 300 ? "#22c55e" : "#dc2626" }).showToast();
                    })
                    .catch(error => {
                        console.error('API Test Error:', error);
                        responseDiv.textContent = `{% trans "Error during API test:" %} ${error.message || error}`;
                        Toastify({ text: "{% trans 'API Test Failed: ' %}" + error.message, backgroundColor: "#dc2626" }).showToast();
                    });
            }
        </script>
        {% endif %}

        <div class="bg-white p-6 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold mb-2">🔗 {% trans "Quick Links" %}</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% if request.user.role == 'ADMIN' %}
                <a href="{% url 'admin:index' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-user-shield mr-1"></i>{% trans "Admin Panel" %}</a>
                <a href="{% url 'swagger-ui' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-book mr-1"></i>{% trans "Swagger" %}</a>
                <a href="{% url 'redoc' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-book-open mr-1"></i>{% trans "Redoc" %}</a>
                {% else %}
                <a href="{% url 'admin:index' %}" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-user-shield mr-1"></i>{% trans "Admin Panel" %}</a>
                {% endif %}
                <a href="/api/users/me/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-user mr-1"></i>{% trans "Profile" %}</a>
                <a href="/api/listings/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-home mr-1"></i>{% trans "Listings" %}</a>
                <a href="/api/bookings/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-calendar-check mr-1"></i>{% trans "Bookings" %}</a>
                <a href="/api/reviews/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-star mr-1"></i>{% trans "Reviews" %}</a>
                {% if request.user.role != 'TENANT' %} {# Убрать кнопку Analytics для Tenant #}
                <a href="/api/analytics/" class="bg-blue-500 text-white p-2 rounded text-center hover:bg-blue-600"><i class="fas fa-chart-line mr-1"></i>{% trans "Analytics" %}</a>
                {% endif %}
            </div>
            <div class="mt-4">
                <form action="{% url 'set_language' %}" method="post" class="inline-block">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <select name="language" onchange="this.form.submit()" class="p-2 border rounded bg-gray-100">
                        {% get_available_languages as LANGUAGES %}
                        {% get_language_info_list for LANGUAGES as languages %}
                        {% for lang in languages %}
                        <option value="{{ lang.code }}" {% if lang.code == LANGUAGE_CODE %}selected{% endif %}>{{ lang.name_local }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        {% if settings.DEBUG and request.user.role == 'ADMIN' %}
        <div class="bg-yellow-100 p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-2">🧪 {% trans "Debug Information" %}</h2>
            <ul class="list-disc pl-5">
                <li>tenant1 / pass123</li>
                <li>landlord1 / pass456</li>
                <li>admin / adminpass</li>
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}
</body>
</html>
