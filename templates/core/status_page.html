<!-- templates/core/status_page.html -->
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "MietSystem ‚Äî Dashboard" %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 16px; max-width: 90%; max-height: 80%; overflow-y: auto; border-radius: 8px; }
        .modal-open { display: block; }
        details[open] summary ~ * { animation: sweep 0.3s ease-in-out; }
        @keyframes sweep { 0% { opacity: 0; margin-top: -10px; } 100% { opacity: 1; margin-top: 0; } }
        .no-js-warning { display: none; }
        .no-js .no-js-warning { display: block; }
        .status-circle { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    </style>
    <noscript>
        <style>
            .js-required { display: none; }
            .no-js-warning { display: block; color: #dc2626; }
        </style>
    </noscript>
</head>
<body class="bg-gray-100 font-sans">
    {% if not request.user.is_authenticated %}
        <div class="container mx-auto p-2">
            <div class="bg-white p-2 rounded-lg shadow-md text-center">
                <h1 class="text-lg font-bold text-red-600">{% trans "Access Denied" %}</h1>
                <p>{% trans "Please" %} <a href="{% url 'login' %}?next={{ request.path|urlencode }}" class="text-blue-500 hover:underline">{% trans "log in" %}</a> {% trans "to view the system status." %}</p>
            </div>
        </div>
    {% else %}
    <div class="container mx-auto p-2 max-w-4xl">
        <h1 class="text-lg font-bold mb-2 text-center">{% trans "MietSystem ‚Äî Dashboard" %}</h1>
        <p class="text-right mb-2 text-sm">
            {% if user_email %}
                <span class="text-gray-700">
                    {% if user_avatar_url %}
                        <img src="{{ user_avatar_url }}" alt="{% trans 'User Avatar' %}" class="w-6 h-6 rounded-full mr-1 object-cover inline-block">
                    {% endif %}
                    {% trans "Welcome" %},
                    {% if user_first_name or user_last_name %}
                        {{ user_first_name }} {{ user_last_name }} ({{ user_role_display }})
                    {% else %}
                        {{ user_email }} ({{ user_role_display }})
                    {% endif %}
                </span>
                <span class="mx-1">|</span>
            {% endif %}
            <a href="{% url 'logout' %}" class="text-blue-500 hover:underline">{% trans "Log out" %}</a>
        </p>
        <div class="no-js-warning text-sm text-center mb-2">{% trans "JavaScript is required for full dashboard functionality. Please enable JavaScript or use the" %} <a href="{% url 'admin:index' %}" class="text-blue-500 hover:underline">{% trans "Admin Panel" %}</a>.</div>
        {% if settings.DEBUG %}
        <div class="bg-yellow-100 p-2 rounded-lg shadow-md mb-2 text-sm">
            <h2 class="text-lg font-semibold mb-1">{% trans "Debug Data" %}</h2>
            <p>Database Status: <strong>{{ data.database.status|default:"N/A" }}</strong></p>
            <p>Redis Status: <strong>{{ data.redis.status|default:"N/A" }}</strong></p>
        </div>
        {% endif %}
        {% if request.user.role == 'ADMIN' %}
        <button class="js-required mb-2 bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm" onclick="toggleAllDetails()">{% trans "Toggle All Sections" %}</button>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
            <details class="bg-white p-2 rounded-lg shadow-md">
                <summary class="text-lg font-semibold cursor-pointer">üîî {% trans "Notifications" %}</summary>
                <div class="p-2 text-sm">
                    {% if data.database.status == 'online' and data.redis.status == 'online' %}
                        <p class="text-green-600 flex items-center"><span class="status-circle bg-green-500"></span> {% trans "All systems are operating normally." %}</p>
                    {% else %}
                        <p class="flex items-center">
                            <span class="status-circle {{ data.database.status|default:'unknown'|yesno:'bg-green-500,bg-red-500,bg-yellow-500,bg-gray-500' }}"></span>
                            {% trans "Database" %}: <strong>{{ data.database.status|default:"Unknown"|capfirst }}</strong> {% if data.database.error %}({{ data.database.error }}){% endif %}
                        </p>
                        <p class="flex items-center">
                            <span class="status-circle {{ data.redis.status|default:'unknown'|yesno:'bg-green-500,bg-red-500,bg-yellow-500,bg-gray-500' }}"></span>
                            {% trans "Redis" %}: <strong>{{ data.redis.status|default:"Unknown"|capfirst }}</strong> {% if data.redis.error %}({{ data.redis.error }}){% endif %}
                        </p>
                    {% endif %}
                </div>
            </details>
            <details class="bg-white p-2 rounded-lg shadow-md">
                <summary class="text-lg font-semibold cursor-pointer">üìä {% trans "System Metrics" %}</summary>
                <div class="p-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                        <div class="flex items-center p-2 border rounded bg-gray-50">
                            <span class="status-circle bg-green-500"></span>
                            <span>{% trans "Server Time" %}: <strong>{{ time_now|date:"j F Y H:i:s" }}</strong></span>
                        </div>
                        <div class="flex items-center p-2 border rounded bg-gray-50">
                            <span class="status-circle {{ data.database.status|default:'unknown'|yesno:'bg-green-500,bg-red-500,bg-yellow-500,bg-gray-500' }}"></span>
                            <span>{% trans "Database" %}: <strong>{{ data.database.status|default:"Unknown"|capfirst }}</strong> {% if data.database.error %}({{ data.database.error }}){% endif %}</span>
                        </div>
                        <div class="flex items-center p-2 border rounded bg-gray-50">
                            <span class="status-circle {{ data.redis.status|default:'unknown'|yesno:'bg-green-500,bg-red-500,bg-yellow-500,bg-gray-500' }}"></span>
                            <span>{% trans "Redis" %}: <strong>{{ data.redis.status|default:"Unknown"|capfirst }}</strong> {% if data.redis.latency_ms %}({{ data.redis.latency_ms }} ms){% endif %} {% if data.redis.error %}({{ data.redis.error }}){% endif %}</span>
                        </div>
                    </div>
                    <button class="js-required mt-2 bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm" onclick="openModal('system')">{% trans "View Graphs" %}</button>
                </div>
            </details>
            <details class="bg-white p-2 rounded-lg shadow-md">
                <summary class="text-lg font-semibold cursor-pointer">üóÑÔ∏è {% trans "Redis Statistics" %}</summary>
                <div class="p-2 text-sm">
                    <p>{% trans "Keys" %}: <strong>{{ data.redis.keys|default:"N/A" }}</strong></p>
                    <p>{% trans "Data Size" %}: <strong>{{ data.redis.used_memory_human|default:"N/A" }}</strong></p>
                    <p>{% trans "Hit Rate" %}: <strong>{{ data.redis.hit_rate|default:"N/A" }}%</strong></p>
                    {# <button class="js-required mt-2 bg-red-500 text-white p-1 rounded hover:bg-red-600 text-sm" onclick="clearRedisCache()"><i class="fas fa-trash-alt mr-1"></i> {% trans "Clear Cache" %}</button> #}
                    <button class="js-required mt-2 bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm" onclick="openModal('redis')">{% trans "View Hit Rate Graph" %}</button>
                </div>
            </details>
            <details class="bg-white p-2 rounded-lg shadow-md">
                <summary class="text-lg font-semibold cursor-pointer">üë• {% trans "Users" %}</summary>
                <div class="p-2 text-sm">
                    <p>{% trans "Total Users" %}: <strong>{{ data.users.total|default:0 }}</strong></p>
                    <p>{% trans "Admins" %}: <strong>{{ data.users.admins|default:0 }}</strong></p>
                    <p>{% trans "Landlords" %}: <strong>{{ data.users.landlords|default:0 }}</strong></p>
                    <p>{% trans "Tenants" %}: <strong>{{ data.users.tenants|default:0 }}</strong></p>
                    <button class="js-required mt-2 bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm" onclick="openModal('users')">{% trans "View Details & Graph" %}</button>
                </div>
            </details>
            <details class="bg-white p-2 rounded-lg shadow-md">
                <summary class="text-lg font-semibold cursor-pointer">üë§ {% trans "Login Attempts" %}</summary>
                <div class="p-2 text-sm">
                    <p>{% trans "Recent Attempts" %}: <strong>{{ data.login_attempts|length }}</strong></p>
                    <button class="js-required mt-2 bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm" onclick="openModal('login')">{% trans "View Details" %}</button>
                </div>
            </details>
            <details class="bg-white p-2 rounded-lg shadow-md">
                <summary class="text-lg font-semibold cursor-pointer">üõ†Ô∏è {% trans "API Testing" %}</summary>
                <div class="p-2 text-sm">
                    <p>{% trans "Total Endpoints" %}: <strong>{{ data.endpoints_total|default:0 }}</strong></p>
                    <p>{% trans "GET Methods" %}: <strong>{{ data.endpoints_get|default:0 }}</strong></p>
                    <p>{% trans "POST Methods" %}: <strong>{{ data.endpoints_post|default:0 }}</strong></p>
                    <p>{% trans "PUT Methods" %}: <strong>{{ data.endpoints_put|default:0 }}</strong></p>
                    <p>{% trans "DELETE Methods" %}: <strong>{{ data.endpoints_delete|default:0 }}</strong></p>
                    <button class="js-required mt-2 bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm" onclick="openModal('api')">{% trans "Test Endpoint" %}</button>
                </div>
            </details>
        </div>
        <div id="system-modal" class="modal js-required">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-1">üìä {% trans "System Metrics" %}</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div class="text-center p-2 border rounded bg-gray-50">
                        <canvas id="cpuChart" class="mx-auto" style="max-height: 150px;"></canvas>
                        <p class="font-semibold text-sm mt-1">{% trans "CPU Usage" %}</p>
                        <p class="text-sm">{{ data.system_metrics.cpu_percent|default:0 }}% / {% trans "Max" %}: {{ data.system_metrics.cpu_max_threshold|default:80 }}%</p>
                    </div>
                    <div class="text-center p-2 border rounded bg-gray-50">
                        <canvas id="memoryChart" class="mx-auto" style="max-height: 150px;"></canvas>
                        <p class="font-semibold text-sm mt-1">{% trans "Memory Usage" %}</p>
                        <p class="text-sm">{{ data.system_metrics.memory_percent|default:0 }}% / {% trans "Max" %}: {{ data.system_metrics.memory_max_threshold|default:90 }}%</p>
                    </div>
                    <div class="text-center p-2 border rounded bg-gray-50">
                        <canvas id="diskChart" class="mx-auto" style="max-height: 150px;"></canvas>
                        <p class="font-semibold text-sm mt-1">{% trans "Free Disk Space" %}</p>
                        <p class="text-sm">{{ data.system_metrics.disk_free_gb|default:0 }} GB / {% trans "Min" %}: {{ data.system_metrics.disk_min_threshold|default:10 }} GB</p>
                    </div>
                </div>
                <button onclick="closeModal('system')" class="mt-2 bg-gray-500 text-white p-1 rounded text-sm">{% trans "Close" %}</button>
            </div>
        </div>
        <div id="redis-modal" class="modal js-required">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-1">üóÑÔ∏è {% trans "Redis Statistics" %}</h2>
                <div class="mt-2">
                    <h3 class="font-semibold text-sm mb-1">{% trans "Hit Rate (Last 24 Hours)" %}</h3>
                    <canvas id="redisHitRateChart" style="max-height: 150px;"></canvas>
                </div>
                <button onclick="closeModal('redis')" class="mt-2 bg-gray-500 text-white p-1 rounded text-sm">{% trans "Close" %}</button>
            </div>
        </div>
        <div id="users-modal" class="modal js-required">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-1">üë• {% trans "Users" %}</h2>
                <canvas id="userChart" class="mb-2" style="max-height: 150px;"></canvas>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('total')"><strong>{{ data.users.total|default:0 }}</strong> {% trans "Total Users" %}</div>
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('admin')"><strong>{{ data.users.admins|default:0 }}</strong> {% trans "Admins" %}</div>
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('landlord')"><strong>{{ data.users.landlords|default:0 }}</strong> {% trans "Landlords" %}</div>
                    <div class="text-center cursor-pointer hover:bg-gray-100 p-1 rounded" onclick="filterUsers('tenant')"><strong>{{ data.users.tenants|default:0 }}</strong> {% trans "Tenants" %}</div>
                </div>
                <div id="userTableContainer" class="mt-2 hidden">
                    <h3 class="font-semibold text-sm mb-1">{% trans "User List" %}</h3>
                    <input type="text" id="userFilterInput" onkeyup="filterUserTable()" placeholder="{% trans 'Search for users...' %}" class="p-1 border rounded w-full text-sm">
                    <table class="min-w-full bg-white border border-gray-200 text-sm">
                        <thead>
                            <tr>
                                <th class="py-1 px-2 border-b">{% trans "Email" %}</th>
                                <th class="py-1 px-2 border-b">{% trans "Role" %}</th>
                                <th class="py-1 px-2 border-b">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
                <button onclick="closeModal('users')" class="mt-2 bg-gray-500 text-white p-1 rounded text-sm">{% trans "Close" %}</button>
            </div>
        </div>
        <div id="login-modal" class="modal js-required">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-1">üë§ {% trans "User Login Attempts" %}</h2>
                <table class="min-w-full bg-white border border-gray-200 text-sm">
                    <thead>
                        <tr>
                            <th class="py-1 px-2 border-b text-left">{% trans "User/Email" %}</th>
                            <th class="py-1 px-2 border-b text-left">{% trans "IP Address" %}</th>
                            <th class="py-1 px-2 border-b text-left">{% trans "Time" %}</th>
                            <th class="py-1 px-2 border-b text-left">{% trans "Result" %}</th>
                            <th class="py-1 px-2 border-b text-left">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attempt in data.login_attempts %}
                        <tr>
                            <td class="py-1 px-2 border-b">{{ attempt.username|default:"N/A" }}</td>
                            <td class="py-1 px-2 border-b">{{ attempt.ip_address|default:"N/A" }}</td>
                            <td class="py-1 px-2 border-b">{{ attempt.attempt_time|date:"j F Y H:i:s" }}</td>
                            <td class="py-1 px-2 border-b">
                                <span class="{% if attempt.success %}text-green-600{% else %}text-red-600{% endif %}">
                                    {% if attempt.success %}{% trans "Success" %}{% else %}{% trans "Failed" %} ({{ attempt.failures_since_start }} {% trans "times" %}){% endif %}
                                </span>
                            </td>
                            <td class="py-1 px-2 border-b">
                                {% if not attempt.success %}
                                <button onclick="blockIp('{{ attempt.ip_address }}')" class="text-red-500 hover:text-red-700 text-xs mr-1">{% trans "Block IP" %}</button>
                                {% endif %}
                                <button onclick="sendNotification('{{ attempt.username|default:"" }}')" class="text-blue-500 hover:text-blue-700 text-xs">{% trans "Notify User" %}</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="py-2 text-center">{% trans "No recent login attempts." %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button onclick="closeModal('login')" class="mt-2 bg-gray-500 text-white p-1 rounded text-sm">{% trans "Close" %}</button>
            </div>
        </div>
        <div id="api-modal" class="modal js-required">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-1">üõ†Ô∏è {% trans "API Testing" %}</h2>
                <p class="text-sm">{% trans "Total Endpoints" %}: <strong>{{ data.endpoints_total|default:0 }}</strong></p>
                <p class="text-sm">{% trans "GET Methods" %}: <strong>{{ data.endpoints_get|default:0 }}</strong></p>
                <p class="text-sm">{% trans "POST Methods" %}: <strong>{{ data.endpoints_post|default:0 }}</strong></p>
                <p class="text-sm">{% trans "PUT Methods" %}: <strong>{{ data.endpoints_put|default:0 }}</strong></p>
                <p class="text-sm">{% trans "DELETE Methods" %}: <strong>{{ data.endpoints_delete|default:0 }}</strong></p>
                <div class="flex space-x-2 mt-2">
                    <a href="{% url 'swagger-ui' %}" class="bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm"><i class="fas fa-book mr-1"></i>{% trans "Swagger" %}</a>
                    <a href="{% url 'redoc' %}" class="bg-blue-500 text-white p-1 rounded hover:bg-blue-600 text-sm"><i class="fas fa-book-open mr-1"></i>{% trans "Redoc" %}</a>
                </div>
                <div class="mt-2 p-2 border rounded bg-gray-50">
                    <h3 class="font-semibold text-sm mb-1">{% trans "Test Single Endpoint" %}</h3>
                    <input type="text" id="apiEndpointUrl" class="w-full p-1 border rounded mb-1 text-sm" placeholder="{% trans 'Enter API endpoint URL (e.g., /api/users/me/)' %}">
                    <select id="apiRequestMethod" class="p-1 border rounded mb-1 w-full text-sm">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                    <textarea id="apiRequestBody" class="w-full p-1 border rounded mb-1 h-16 text-sm" placeholder="{% trans 'Enter JSON request body for POST/PUT (optional)' %}"></textarea>
                    <button onclick="testEndpoint()" class="bg-green-500 text-white p-1 rounded hover:bg-green-600 w-full text-sm">{% trans "Test Endpoint" %}</button>
                    <div id="apiResponse" class="mt-2 p-1 bg-gray-100 rounded border border-gray-200 overflow-auto max-h-32 text-xs">
                        {% trans "API Response will appear here." %}
                    </div>
                </div>
                <button onclick="closeModal('api')" class="mt-2 bg-gray-500 text-white p-1 rounded text-sm">{% trans "Close" %}</button>
            </div>
        </div>
        {% endif %}
        <div class="bg-white p-2 rounded-lg shadow-md mb-2">
            <h2 class="text-lg font-semibold mb-1">{% trans "My Dashboard" %}</h2>
            {% if request.user.role == 'LANDLORD' %}
            <p class="text-sm">{% trans "My Listings" %}: <strong>{{ data.stats.listings|default:0 }}</strong> <a href="/api/listings/" class="text-blue-500 hover:underline ml-1">{% trans "View all listings" %}</a></p>
            <p class="text-sm">{% trans "My Bookings" %}: <strong>{{ data.stats.bookings|default:0 }}</strong> <a href="/api/bookings/" class="text-blue-500 hover:underline ml-1">{% trans "View all bookings" %}</a></p>
            {% elif request.user.role == 'TENANT' %}
            <p class="text-sm">{% trans "My Bookings" %}: <strong>{{ data.stats.bookings|default:0 }}</strong> <a href="/api/bookings/" class="text-blue-500 hover:underline ml-1">{% trans "View all bookings" %}</a></p>
            <p class="text-sm">{% trans "Total Listings" %}: <strong>{{ data.stats.listings|default:0 }}</strong> <a href="/api/listings/" class="text-blue-500 hover:underline ml-1">{% trans "View all listings" %}</a></p>
            {% elif request.user.role == 'ADMIN' %}
            <p class="text-sm">{% trans "You have full access to system monitoring and user management." %}</p>
            <div class="grid grid-cols-2 gap-2 text-sm mt-1">
                <p>{% trans "Listings" %}: <strong>{{ data.stats.listings|default:0 }}</strong></p>
                <p>{% trans "Bookings" %}: <strong>{{ data.stats.bookings|default:0 }}</strong></p>
                <p>{% trans "Reviews" %}: <strong>{{ data.stats.reviews|default:0 }}</strong></p>
                <p>{% trans "Locations" %}: <strong>{{ data.stats.locations|default:0 }}</strong></p>
            </div>
            {% endif %}
        </div>
        <div class="bg-white p-2 rounded-lg shadow-md mb-2">
            <h2 class="text-lg font-semibold mb-1">üîó {% trans "Quick Links" %}</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <a href="{% url 'admin:index' %}" class="bg-blue-500 text-white p-1 rounded text-center hover:bg-blue-600 text-sm"><i class="fas fa-user-shield mr-1"></i>{% trans "Admin Panel" %}</a>
                <a href="/api/users/me/" class="bg-blue-500 text-white p-1 rounded text-center hover:bg-blue-600 text-sm"><i class="fas fa-user mr-1"></i>{% trans "Profile" %}</a>
                <a href="/api/listings/" class="bg-blue-500 text-white p-1 rounded text-center hover:bg-blue-600 text-sm"><i class="fas fa-home mr-1"></i>{% trans "Listings" %}</a>
                <a href="/api/bookings/" class="bg-blue-500 text-white p-1 rounded text-center hover:bg-blue-600 text-sm"><i class="fas fa-calendar-check mr-1"></i>{% trans "Bookings" %}</a>
                <a href="/api/reviews/" class="bg-blue-500 text-white p-1 rounded text-center hover:bg-blue-600 text-sm"><i class="fas fa-star mr-1"></i>{% trans "Reviews" %}</a>
                {% if request.user.role != 'TENANT' %}
                <a href="/api/analytics/" class="bg-blue-500 text-white p-1 rounded text-center hover:bg-blue-600 text-sm"><i class="fas fa-chart-line mr-1"></i>{% trans "Analytics" %}</a>
                {% endif %}
            </div>
            <div class="mt-2">
                <select id="language-switcher" class="p-1 border rounded bg-gray-100 text-sm">
                    {% get_available_languages as LANGUAGES %}
                    {% get_language_info_list for LANGUAGES as languages %}
                    {% for lang in languages %}
                    <option value="{{ lang.code }}" {% if lang.code == LANGUAGE_CODE %}selected{% endif %}>{{ lang.name_local }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% if settings.DEBUG and request.user.role == 'ADMIN' %}
        <div class="bg-yellow-100 p-2 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-1">üß™ {% trans "Debug Information" %}</h2>
            <ul class="list-disc pl-5 text-sm">
                <li>tenant1 / pass123</li>
                <li>landlord1 / pass456</li>
                <li>admin / adminpass</li>
            </ul>
        </div>
        {% endif %}
        <script>
            // –ö–æ–¥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            document.getElementById('language-switcher').addEventListener('change', function() {
                const langCode = this.value;
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
                console.log(`Language switcher changed. New language code: ${langCode}`); 
        
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'set_language' %}";
        
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token|escapejs }}'; 
                form.appendChild(csrfInput);
        
                const nextInput = document.createElement('input');
                nextInput.type = 'hidden';
                nextInput.name = 'next';
                nextInput.value = window.location.pathname;
                form.appendChild(nextInput);
        
                const langInput = document.createElement('input');
                langInput.type = 'hidden';
                langInput.name = 'language';
                langInput.value = langCode;
                form.appendChild(langInput);
        
                document.body.appendChild(form);
                form.submit();
            });
            // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏, —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –≤ –æ–¥–∏–Ω –±–ª–æ–∫ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
            function toggleAllDetails() {
                const details = document.querySelectorAll('details');
                const allOpen = Array.from(details).every(d => d.open);
                details.forEach(d => d.open = !allOpen);
            }
            function openModal(modalId) {
                document.getElementById(`${modalId}-modal`).classList.add('modal-open');
            }
            function closeModal(modalId) {
                document.getElementById(`${modalId}-modal`).classList.remove('modal-open');
            }
            const cpuUsage = parseFloat("{{ data.system_metrics.cpu_percent|default:0 }}");
            const memoryUsage = parseFloat("{{ data.system_metrics.memory_percent|default:0 }}");
            const diskFree = parseFloat("{{ data.system_metrics.disk_free_gb|default:0 }}");
            const cpuMaxThreshold = parseFloat("{{ data.system_metrics.cpu_max_threshold|default:80 }}");
            const memoryMaxThreshold = parseFloat("{{ data.system_metrics.memory_max_threshold|default:90 }}");
            const diskMinThreshold = parseFloat("{{ data.system_metrics.disk_min_threshold|default:10 }}");
            const cpuColor = cpuUsage > cpuMaxThreshold ? '#dc2626' : (cpuUsage > (cpuMaxThreshold * 0.8)) ? '#f59e0b' : '#22c55e';
            const memoryColor = memoryUsage > memoryMaxThreshold ? '#dc2626' : (memoryUsage > (memoryMaxThreshold * 0.8)) ? '#f59e0b' : '#22c55e';
            const diskColor = diskFree < diskMinThreshold ? '#dc2626' : (diskFree < (diskMinThreshold * 2)) ? '#f59e0b' : '#22c55e';
            
            new Chart(document.getElementById('cpuChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [cpuUsage, 100 - cpuUsage], backgroundColor: [cpuColor, '#e5e7eb'] }] },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('memoryChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [memoryUsage, 100 - memoryUsage], backgroundColor: [memoryColor, '#e5e7eb'] }] },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('diskChart'), {
                type: 'doughnut',
                data: { datasets: [{ data: [diskFree, 100 - diskFree], backgroundColor: [diskColor, '#e5e7eb'] }] },
                options: { responsive: true, cutout: '80%', plugins: { legend: { display: false } } }
            });
            const redisHitRateData = {
                labels: Array.from({length: 24}, (_, i) => `${24 - i}{% trans "h ago" %}`).reverse(),
                datasets: [{ label: '{% trans "Hit Rate" %}', data: JSON.parse("{{ data.redis.hit_rate_history }}"), borderColor: '#f59e0b', tension: 0.1, fill: false }]
            };
            new Chart(document.getElementById('redisHitRateChart'), {
                type: 'line',
                data: redisHitRateData,
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: '{% trans "Hit Rate (%)" %}' } }, x: { title: { display: true, text: '{% trans "Time" %}' } } }, plugins: { legend: { display: false } } }
            });
            let userChartInstance = null;
            const userChartData = {
                labels: ['{% trans "Admins" %}', '{% trans "Landlords" %}', '{% trans "Tenants" %}'],
                datasets: [{ data: [{{ data.users.admins|default:0 }}, {{ data.users.landlords|default:0 }}, {{ data.users.tenants|default:0 }}], backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b'] }]
            };
            function initUserChart() {
                const ctx = document.getElementById('userChart').getContext('2d');
                userChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: userChartData,
                    options: { responsive: true, onClick: (event, elements) => { if (elements.length > 0) { const index = elements[0].index; const role = userChartData.labels[index].toLowerCase(); filterUsers(role.replace(/ /g, '')); } } }
                });
            }
            initUserChart();
            let allUsersData = [];
            function fetchUsersAndRenderTable(role = 'total') {
                document.getElementById('userTableContainer').classList.remove('hidden');
                const userTableBody = document.getElementById('userTableBody');
                userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-2">{% trans "Loading users..." %}</td></tr>';
                fetch('/api/users/all_users_for_admin_dashboard/' + (role !== 'total' ? '?role=' + role : ''), {
                    credentials: 'include'
                })
                    .then(response => response.json())
                    .then(data => {
                        allUsersData = data.users || [];
                        renderUserTable(role);
                    })
                    .catch(error => {
                        console.error('Error fetching users:', error);
                        userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-2 text-red-600">{% trans "Failed to load users." %}</td></tr>';
                    });
            }
            function renderUserTable(roleFilter = 'total') {
                const userTableBody = document.getElementById('userTableBody');
                userTableBody.innerHTML = '';
                const filteredUsers = allUsersData.filter(user => roleFilter === 'total' ? true : user.role.toLowerCase() === roleFilter);
                if (filteredUsers.length === 0) {
                    userTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-2">{% trans "No users found for this filter." %}</td></tr>';
                    return;
                }
                filteredUsers.forEach(user => {
                    const row = userTableBody.insertRow();
                    row.dataset.role = user.role.toLowerCase();
                    row.insertCell().textContent = user.email;
                    row.insertCell().textContent = user.role_display || user.role;
                    const actionsCell = row.insertCell();
                    actionsCell.className = "py-1 px-2 border-b";
                    actionsCell.innerHTML = `<button onclick="blockUser('${user.id}')" class="text-red-500 hover:text-red-700 text-xs mr-1">{% trans "Block" %}</button><button onclick="resetPassword('${user.id}')" class="text-blue-500 hover:text-blue-700 text-xs">{% trans "Reset Pass" %}</button>`;
                });
            }
            function filterUsers(role) {
                if (allUsersData.length === 0) fetchUsersAndRenderTable(role);
                else renderUserTable(role);
            }
            function filterUserTable() {
                const input = document.getElementById('userFilterInput');
                const filter = input.value.toLowerCase();
                const table = document.getElementById('userTableBody');
                const tr = table.getElementsByTagName('tr');
                for (let i = 0; i < tr.length; i++) {
                    const tdEmail = tr[i].getElementsByTagName('td')[0];
                    const tdRole = tr[i].getElementsByTagName('td')[1];
                    if (tdEmail || tdRole) {
                        const emailText = tdEmail ? tdEmail.textContent.toLowerCase() : '';
                        const roleText = tdRole ? tdRole.textContent.toLowerCase() : '';
                        tr[i].style.display = (emailText.indexOf(filter) > -1 || roleText.indexOf(filter) > -1) ? "" : "none";
                    }
                }
            }
            function blockUser(userId) {
                if (confirm(`{% trans "Are you sure you want to block user ID:" %} ${userId}?`)) {
                    fetch(`/api/users/${userId}/block/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                        .then(response => response.json())
                        .then(data => { if (data.status === 'success') Toastify({ text: `{% trans "User ID:" %} ${userId} {% trans "blocked." %}`, backgroundColor: "#22c55e" }).showToast(); else Toastify({ text: `{% trans "Failed to block user:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast(); });
                }
            }
            function resetPassword(userId) {
                if (confirm(`{% trans "Are you sure you want to reset password for user ID:" %} ${userId}?`)) {
                    fetch(`/api/users/${userId}/reset-password/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                        .then(response => response.json())
                        .then(data => { if (data.status === 'success') Toastify({ text: `{% trans "Password for user ID:" %} ${userId} {% trans "reset." %}`, backgroundColor: "#22c55e" }).showToast(); else Toastify({ text: `{% trans "Failed to reset password:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast(); });
                }
            }
            function blockIp(ipAddress) {
                if (confirm(`{% trans "Are you sure you want to block IP address:" %} ${ipAddress}?`)) {
                    fetch(`/api/security/block-ip/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }, body: JSON.stringify({ ip: ipAddress }) })
                        .then(response => response.json())
                        .then(data => { if (data.status === 'success') Toastify({ text: `{% trans "IP Address:" %} ${ipAddress} {% trans "blocked." %}`, backgroundColor: "#22c55e" }).showToast(); else Toastify({ text: `{% trans "Failed to block IP:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast(); })
                        .catch(error => { console.error('Error blocking IP:', error); Toastify({ text: "{% trans 'An error occurred while blocking IP.' %}", backgroundColor: "#dc2626" }).showToast(); });
                }
            }
            function sendNotification(username) {
                if (username && confirm(`{% trans "Send notification to user:" %} ${username}?`)) {
                    fetch(`/api/notifications/send/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username, message: "{% trans 'There was a recent login attempt on your account.' %}" }) })
                        .then(response => response.json())
                        .then(data => { if (data.status === 'success') Toastify({ text: `{% trans "Notification sent to" %} ${username}.`, backgroundColor: "#22c55e" }).showToast(); else Toastify({ text: `{% trans "Failed to send notification:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast(); })
                        .catch(error => { console.error('Error sending notification:', error); Toastify({ text: "{% trans 'An error occurred while sending notification.' %}", backgroundColor: "#dc2626" }).showToast(); });
                } else if (!username) {
                    Toastify({ text: "{% trans 'Cannot send notification: User email/username is missing.' %}", backgroundColor: "#f59e0b" }).showToast();
                }
            }
            function testEndpoint() {
                const url = document.getElementById('apiEndpointUrl').value;
                const method = document.getElementById('apiRequestMethod').value;
                const body = document.getElementById('apiRequestBody').value;
                const responseDiv = document.getElementById('apiResponse');
                if (!url) {
                    Toastify({ text: "{% trans 'Please enter an API endpoint URL.' %}", backgroundColor: "#f59e0b" }).showToast();
                    return;
                }
                responseDiv.textContent = '{% trans "Testing..." %}';
                const options = { method: method, headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Accept': 'application/json' } };
                if (method === 'POST' || method === 'PUT') {
                    try { options.body = JSON.parse(body); options.headers['Content-Type'] = 'application/json'; } catch (e) { Toastify({ text: "{% trans 'Invalid JSON body.' %}", backgroundColor: "#dc2626" }).showToast(); responseDiv.textContent = '{% trans "Error: Invalid JSON body." %}'; return; }
                }
                fetch(url, options)
                    .then(response => {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) return response.json().then(json => ({ status: response.status, json: json }));
                        else return response.text().then(text => ({ status: response.status, text: text }));
                    })
                    .then(data => { if (data.json) responseDiv.textContent = `Status: ${data.status}\n${JSON.stringify(data.json, null, 2)}`; else responseDiv.textContent = `Status: ${data.status}\n${data.text}`; Toastify({ text: `{% trans "Test completed with status:" %} ${data.status}`, backgroundColor: data.status >= 200 && data.status < 300 ? "#22c55e" : "#dc2626" }).showToast(); })
                    .catch(error => { console.error('API Test Error:', error); responseDiv.textContent = `{% trans "Error during API test:" %} ${error.message || error}`; Toastify({ text: "{% trans 'API Test Failed: ' %}" + error.message, backgroundColor: "#dc2626" }).showToast(); });
            }
            function clearRedisCache() {
                if (confirm('{% trans "Are you sure you want to clear the Redis cache?" %}')) {
                    fetch('/api/redis/clear-cache/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                        .then(response => response.json())
                        .then(data => { if (data.status === 'success') Toastify({ text: '{% trans "Redis cache cleared." %}', backgroundColor: "#22c55e" }).showToast(); else Toastify({ text: `{% trans "Failed to clear cache:" %} ${data.message}`, backgroundColor: "#dc2626" }).showToast(); })
                        .catch(error => { console.error('Error clearing cache:', error); Toastify({ text: "{% trans 'An error occurred while clearing cache.' %}", backgroundColor: "#dc2626" }).showToast(); });
                }
            }
        </script>
    </div>
    {% endif %}
</body>
</html>